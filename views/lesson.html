<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>B√†i thi - √în luy·ªán V·∫≠t l√≠</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Dark theme colors */
            --bg-primary: #0f0f14;
            --bg-secondary: #1a1a24;
            --bg-tertiary: #252533;
            --bg-card: #1e1e2a;
            --bg-card-hover: #262635;
            
            /* Text colors */
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --text-tertiary: #71717a;
            
            /* Accent colors */
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            
            /* Borders */
            --border-color: #2a2a3a;
            --border-focus: #6366f1;
            
            /* Spacing */
            --space-xs: 0.5rem;
            --space-sm: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2rem;
            --space-xl: 3rem;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
        }

        /* Loading Indicator */
        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Main Layout */
        .exam-container {
            display: flex;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar Navigation */
        .exam-sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            flex-shrink: 0;
            position: relative;
            z-index: 1000; /* Ensure sidebar is above overlay */
        }

        .exam-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-color);
        }

        .exam-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
        }

        .exam-timer {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 1.125rem;
            color: var(--accent-warning);
            font-weight: 500;
        }

        /* Question Navigation */
        .question-nav {
            padding: var(--space-md);
        }

        .question-nav-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .question-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-xs);
        }

        .question-nav-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .question-nav-item:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
        }

        .question-nav-item.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .question-nav-item.answered {
            background: var(--bg-tertiary);
            border-color: var(--accent-success);
        }

        .question-nav-item.flagged::after {
            content: '';
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background: var(--accent-warning);
            border-radius: 50%;
        }

        /* Progress Stats */
        .exam-stats {
            padding: var(--space-md);
            border-top: 1px solid var(--border-color);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
            font-size: 0.875rem;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Main Content Area */
        .exam-content {
            flex: 1;
            overflow-y: auto;
            background: var(--bg-primary);
        }

        .content-wrapper {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--space-lg) var(--space-xl);
        }

        /* Question Card */
        .question-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }

        .question-number {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .question-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .btn-flag {
            padding: var(--space-xs) var(--space-sm);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .btn-flag:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-warning);
            color: var(--accent-warning);
        }

        .btn-flag.flagged {
            background: var(--accent-warning);
            border-color: var(--accent-warning);
            color: white;
        }

        .question-text {
            font-size: 1.125rem;
            line-height: 1.7;
            color: var(--text-primary);
            margin-bottom: var(--space-md);
        }

        .question-image-container {
            margin-bottom: var(--space-md);
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .lesson-image-container {
            margin-bottom: var(--space-lg);
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--space-md);
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .question-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            cursor: zoom-in;
            transition: opacity 0.3s;
            display: block;
        }

        .lesson-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            cursor: zoom-in;
            transition: opacity 0.3s;
            display: block;
        }

        .question-image:hover,
        .lesson-image:hover {
            opacity: 0.9;
        }

        /* Multiple Choice Options */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .option-card {
            position: relative;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: var(--space-md);
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .option-card input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .option-card.selected {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .option-label {
            display: flex;
            align-items: flex-start;
            gap: var(--space-sm);
            cursor: pointer;
            width: 100%;
        }

        .option-letter {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border-radius: 50%;
            font-weight: 600;
            transition: all 0.2s;
        }

        .option-card.selected .option-letter {
            background: white;
            color: var(--accent-primary);
        }

        .option-text {
            flex: 1;
            line-height: 1.6;
        }

        /* True/False Options */
        .truefalse-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .truefalse-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: var(--space-lg);
            align-items: center;
            padding: var(--space-md);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .truefalse-text {
            color: var(--text-primary);
            line-height: 1.6;
        }

        .truefalse-buttons {
            display: flex;
            gap: var(--space-sm);
        }

        .truefalse-btn {
            position: relative;
            padding: var(--space-xs) var(--space-md);
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .truefalse-btn input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .truefalse-btn:hover {
            border-color: var(--accent-primary);
        }

        .truefalse-btn.selected-true {
            background: var(--accent-success);
            border-color: var(--accent-success);
            color: white;
        }

        .truefalse-btn.selected-false {
            background: var(--accent-danger);
            border-color: var(--accent-danger);
            color: white;
        }

        /* Number Input */
        .number-input-container {
            max-width: 300px;
        }

        .modern-number-input {
            width: 100%;
            padding: var(--space-md);
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .modern-number-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Navigation Buttons */
        .navigation-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-lg);
            padding-top: var(--space-lg);
            border-top: 1px solid var(--border-color);
        }

        .nav-button {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-lg);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .nav-button:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .submit-button {
            padding: var(--space-sm) var(--space-xl);
            background: var(--accent-primary);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .submit-button:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .submit-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Floating Submit Button */
        .floating-submit-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: var(--space-sm) var(--space-lg);
            background: var(--accent-primary);
            border: none;
            border-radius: 50px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
            z-index: 998; /* Below sidebar overlay */
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            min-width: auto;
        }

        .floating-submit-button:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(99, 102, 241, 0.4);
        }

        .floating-submit-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .floating-submit-button i {
            font-size: 0.9rem;
        }

        /* Zoom Controls in Sidebar */
        .zoom-controls-sidebar {
            padding: var(--space-md);
            border-top: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.02);
        }

        .zoom-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .zoom-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .zoom-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: scale(1.1);
        }

        .zoom-btn:active {
            transform: scale(0.95);
        }

        .zoom-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .zoom-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
            user-select: none;
            min-width: 50px;
            text-align: center;
        }

        .zoom-reset-btn {
            width: 100%;
            padding: var(--space-xs) var(--space-sm);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
        }

        .zoom-reset-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Zoom transform container */
        .exam-container {
            transform-origin: top left;
            transition: transform 0.3s ease;
        }

        /* Mobile Sidebar Toggle */
        .mobile-sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            z-index: 1001; /* Above sidebar and overlay */
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .mobile-sidebar-toggle:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .mobile-sidebar-toggle:active {
            transform: scale(0.95);
        }

        /* Sidebar Overlay for Mobile */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999; /* Below sidebar to allow interaction */
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .sidebar-overlay.show {
            display: block;
            opacity: 1;
        }

        /* Enhanced Image Modal */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            z-index: 9990;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            overflow: hidden;
        }

        .image-modal.open {
            display: flex;
            opacity: 1;
        }

        .modal-image-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .modal-image {
            display: block;
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            transition: transform 0.1s ease;
            transform-origin: center;
            cursor: move;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .close-button {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 9999;
            transition: all 0.3s ease;
        }

        .close-button:hover {
            background: rgba(255, 107, 107, 0.3);
            border-color: #ff6b6b;
            transform: rotate(90deg) scale(1.1);
        }

        .close-button:before, .close-button:after {
            content: '';
            position: absolute;
            width: 24px;
            height: 3px;
            background: white;
            border-radius: 2px;
        }

        .close-button:before {
            transform: rotate(45deg);
        }

        .close-button:after {
            transform: rotate(-45deg);
        }

        .zoom-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 9999;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 10px 20px;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .zoom-button, .reset-zoom-button {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .reset-zoom-button {
            width: auto;
            padding: 0 20px;
            border-radius: 20px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .zoom-button:hover, .reset-zoom-button:hover {
            background: rgba(168, 85, 247, 0.3);
            border-color: #a855f7;
            transform: scale(1.1);
        }

        /* Confirmation Modal */
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .confirmation-modal.show {
            display: flex;
        }

        .confirmation-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: var(--space-xl);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .confirmation-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: var(--space-md);
            color: var(--text-primary);
        }

        .confirmation-message {
            color: var(--text-secondary);
            margin-bottom: var(--space-lg);
            line-height: 1.6;
        }

        .confirmation-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            padding: var(--space-md);
            background: var(--bg-card);
            border-radius: 8px;
        }

        .confirmation-stat {
            text-align: center;
        }

        .confirmation-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .confirmation-stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .confirmation-actions {
            display: flex;
            gap: var(--space-md);
            justify-content: center;
        }

        .btn-cancel {
            padding: var(--space-sm) var(--space-xl);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-cancel:hover {
            background: var(--bg-card-hover);
        }

        .btn-confirm {
            padding: var(--space-sm) var(--space-xl);
            background: var(--accent-primary);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
        }

        .btn-confirm:hover:not(:disabled) {
            background: var(--accent-secondary);
        }

        .btn-confirm:disabled {
            background: var(--text-tertiary);
            cursor: not-allowed;
        }

        .btn-confirm.loading {
            background: var(--text-tertiary);
            cursor: not-allowed;
        }

        .btn-confirm .loading-dots {
            display: inline-flex;
            gap: 2px;
        }

        .btn-confirm .loading-dots span {
            width: 4px;
            height: 4px;
            background: currentColor;
            border-radius: 50%;
            animation: loadingDots 1.4s infinite ease-in-out;
        }

        .btn-confirm .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .btn-confirm .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        .btn-confirm .loading-dots span:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes loadingDots {
            0%, 80%, 100% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            40% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .exam-sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease;
                box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
            }

            .exam-sidebar.show {
                left: 0;
                box-shadow: 4px 0 30px rgba(0, 0, 0, 0.5);
            }

            .mobile-sidebar-toggle {
                display: flex !important;
            }

            .floating-submit-button {
                top: 20px;
                right: 15px;
                padding: 12px 20px;
                font-size: 0.9rem;
            }


            .content-wrapper {
                padding: var(--space-md);
                padding-top: 80px;
            }

            .question-card {
                padding: var(--space-lg);
                margin-bottom: var(--space-md);
            }

            .question-text {
                font-size: 1.1rem;
                line-height: 1.7;
            }

            .option-text {
                font-size: 1rem;
                line-height: 1.5;
            }

            .option-card {
                padding: var(--space-md) var(--space-sm);
            }

            .truefalse-item {
                grid-template-columns: 1fr;
                gap: var(--space-sm);
                padding: var(--space-md);
            }

            .truefalse-text {
                font-size: 1rem;
                line-height: 1.6;
            }

            .truefalse-buttons {
                justify-content: flex-start;
            }

            .truefalse-btn {
                padding: var(--space-sm) var(--space-md);
                font-size: 0.95rem;
            }

            .modern-number-input {
                font-size: 1.1rem;
                padding: var(--space-md);
            }

            .lesson-image {
                max-height: 250px;
            }

            .question-image {
                max-height: 300px;
            }

            .question-number {
                font-size: 1.2rem;
            }

            .btn-flag {
                padding: var(--space-xs) var(--space-sm);
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .floating-submit-button {
                padding: 10px 16px;
                font-size: 0.85rem;
                top: 15px;
                right: 15px;
            }

            .mobile-sidebar-toggle {
                width: 45px;
                height: 45px;
                top: 15px;
                left: 15px;
                font-size: 1.1rem;
            }

            .content-wrapper {
                padding: var(--space-sm);
                padding-top: 75px;
            }


            .question-card {
                padding: var(--space-md);
            }

            .question-text {
                font-size: 1.05rem;
            }

            .option-text {
                font-size: 0.95rem;
            }

            .lesson-image-container {
                padding: var(--space-sm);
            }

            .lesson-image {
                max-height: 200px;
            }

            .question-image {
                max-height: 250px;
            }
        }
        
        /* Practice Mode Indicator */
        .practice-mode-indicator {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: var(--space-sm) var(--space-lg);
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            font-weight: 500;
            margin-top: var(--space-sm);
            margin-bottom: var(--space-md);
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .practice-mode-indicator i {
            font-size: 1.25rem;
        }
        
        /* Countdown Timer Animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Mobile Zoom Fixes */
        @media (max-width: 768px) {
            /* Ensure exam container fills viewport when zoomed */
            .exam-container {
                min-width: 100vw;
                transform-origin: top left !important;
            }
            
            /* Prevent content from shrinking on zoom out */
            .exam-content {
                width: 100% !important;
                min-width: 100vw;
            }
            
            /* Ensure content wrapper maintains proper width */
            .content-wrapper {
                width: 100%;
                max-width: none;
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            /* Question cards should fill available width */
            .question-card {
                width: 100%;
                box-sizing: border-box;
            }
            
            /* Fix for zoomed out state */
            body.zoomed-out {
                overflow-x: hidden;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Indicator -->
    <div id="loading-indicator" class="loading-indicator">
        <div class="spinner"></div>
        <p>ƒêang t·∫£i b√†i thi...</p>
    </div>

    <!-- Floating Submit Button -->
    <button class="floating-submit-button" id="submit-quiz-btn">
        <i class="fas fa-paper-plane"></i>
        N·ªôp b√†i
    </button>


    <!-- Mobile Sidebar Toggle -->
    <button class="mobile-sidebar-toggle" id="mobile-sidebar-toggle" style="display: none;">
        <i class="fas fa-bars"></i>
    </button>

    <div class="exam-container">
        <!-- Sidebar -->
        <aside class="exam-sidebar" id="exam-sidebar">
            <div class="exam-header">
                <h2 class="exam-title" id="lesson-title">ƒêang t·∫£i...</h2>
                <div class="exam-timer">
                    <i class="fas fa-clock"></i>
                    <span id="timer">00:00:00</span>
                </div>
            </div>

            <div class="question-nav">
                <h3 class="question-nav-title">ƒêi·ªÅu h∆∞·ªõng c√¢u h·ªèi</h3>
                <div class="question-grid" id="question-nav-grid">
                    <!-- Question navigation buttons will be generated here -->
                </div>
            </div>

            <div class="exam-stats">
                <div class="stat-item">
                    <span class="stat-label">ƒê√£ tr·∫£ l·ªùi</span>
                    <span class="stat-value" id="answered-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Ch∆∞a tr·∫£ l·ªùi</span>
                    <span class="stat-value" id="unanswered-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ƒê√£ ƒë√°nh d·∫•u</span>
                    <span class="stat-value" id="flagged-count">0</span>
                </div>
            </div>

            <!-- Zoom Controls in Sidebar -->
            <div class="zoom-controls-sidebar">
                <h3 class="zoom-title">Ph√≥ng to/Thu nh·ªè</h3>
                <div class="zoom-buttons">
                    <button class="zoom-btn" id="decrease-zoom" title="Thu nh·ªè">
                        <i class="fas fa-minus"></i>
                    </button>
                    <span class="zoom-label" id="zoom-percentage">100%</span>
                    <button class="zoom-btn" id="increase-zoom" title="Ph√≥ng to">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <button class="zoom-reset-btn" id="reset-zoom" title="ƒê·∫∑t l·∫°i">
                    <i class="fas fa-undo"></i> ƒê·∫∑t l·∫°i
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="exam-content">
            <div class="content-wrapper">
                <div id="questions-container">
                    <!-- Questions will be dynamically inserted here -->
                </div>

                <div class="navigation-container">
                    <button class="nav-button" id="prev-button" onclick="navigateQuestion(-1)">
                        <i class="fas fa-chevron-left"></i>
                        C√¢u tr∆∞·ªõc
                    </button>
                    
                    <button class="nav-button" id="next-button" onclick="navigateQuestion(1)">
                        C√¢u sau
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>


    <!-- Enhanced Image Modal -->
    <div id="image-modal" class="image-modal">
        <div class="modal-image-container">
            <img id="modal-image" class="modal-image" alt="Zoomed Image">
        </div>
        <div class="close-button" id="close-modal"></div>
        <div class="zoom-controls">
            <button class="zoom-button" id="zoom-out">‚àí</button>
            <button class="reset-zoom-button" id="reset-zoom">Reset</button>
            <button class="zoom-button" id="zoom-in">+</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirmation-modal" id="confirmation-modal">
        <div class="confirmation-content">
            <h3 class="confirmation-title">X√°c nh·∫≠n n·ªôp b√†i</h3>
            <p class="confirmation-message">
                B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i kh√¥ng? Sau khi n·ªôp, b·∫°n kh√¥ng th·ªÉ thay ƒë·ªïi c√¢u tr·∫£ l·ªùi.
            </p>
            <div class="confirmation-stats">
                <div class="confirmation-stat">
                    <div class="confirmation-stat-value" id="modal-answered">0</div>
                    <div class="confirmation-stat-label">ƒê√£ tr·∫£ l·ªùi</div>
                </div>
                <div class="confirmation-stat">
                    <div class="confirmation-stat-value" id="modal-unanswered">0</div>
                    <div class="confirmation-stat-label">Ch∆∞a tr·∫£ l·ªùi</div>
                </div>
                <div class="confirmation-stat">
                    <div class="confirmation-stat-value" id="modal-flagged">0</div>
                    <div class="confirmation-stat-label">ƒê√£ ƒë√°nh d·∫•u</div>
                </div>
            </div>
            <div class="confirmation-actions">
                <button class="btn-cancel" onclick="closeConfirmationModal()">Quay l·∫°i</button>
                <button class="btn-confirm" onclick="confirmSubmit()">N·ªôp b√†i</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/encryption.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <script>
        // Global variables
        let currentQuestionIndex = 0;
        let currentLessonData = null;
        let questionMappings = {};
        let answeredQuestions = new Set();
        let flaggedQuestions = new Set();
        let startTime = Date.now();
        let timerInterval = null;

        // Timer function
        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        // Authentication functions
        async function checkStudentAuthentication() {
            try {
                const response = await fetch('/api/auth/student/check');
                if (!response.ok) {
                    console.log('Auth check failed, user not authenticated');
                    return false;
                }
                const authData = await response.json();

                // Handle nested response structure
                if (authData.success && authData.data) {
                    if (authData.data.isAuthenticated && authData.data.student) {
                        console.log('Student authenticated:', authData.data.student.name);
                        return true;
                    }
                }
                
                console.log('Student not authenticated');
                return false;
            } catch (error) {
                console.error('Error checking student authentication:', error);
                return false;
            }
        }

        function promptForLogin() {
            const currentUrl = window.location.pathname + window.location.search;
            if (confirm('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ l√†m b√†i t·∫≠p. Chuy·ªÉn ƒë·∫øn trang ƒëƒÉng nh·∫≠p?')) {
                window.location.href = '/student/login?redirect=' + encodeURIComponent(currentUrl);
            }
        }

        // Utility functions
        function showLoader(show) {
            const loader = document.getElementById('loading-indicator');
            if (loader) {
                loader.style.display = show ? 'flex' : 'none';
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Question navigation
        function navigateToQuestion(index) {
            const questions = document.querySelectorAll('.question-card');
            if (index >= 0 && index < questions.length) {
                // Hide all questions
                questions.forEach(q => q.style.display = 'none');
                
                // Show selected question
                questions[index].style.display = 'block';
                currentQuestionIndex = index;
                
                // Update navigation state
                updateNavigationState();
                
                // Scroll to top
                document.querySelector('.exam-content').scrollTop = 0;
            }
        }

        function navigateQuestion(direction) {
            navigateToQuestion(currentQuestionIndex + direction);
        }

        function updateNavigationState() {
            // Update nav buttons in sidebar
            const navItems = document.querySelectorAll('.question-nav-item');
            navItems.forEach((item, index) => {
                item.classList.toggle('active', index === currentQuestionIndex);
            });

            // Update prev/next buttons
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            const totalQuestions = document.querySelectorAll('.question-card').length;
            
            prevButton.disabled = currentQuestionIndex === 0;
            nextButton.disabled = currentQuestionIndex === totalQuestions - 1;

            // Update stats
            updateStats();
        }

        function updateStats() {
            const totalQuestions = document.querySelectorAll('.question-card').length;
            const answeredCount = answeredQuestions.size;
            const unansweredCount = totalQuestions - answeredCount;
            const flaggedCount = flaggedQuestions.size;

            document.getElementById('answered-count').textContent = answeredCount;
            document.getElementById('unanswered-count').textContent = unansweredCount;
            document.getElementById('flagged-count').textContent = flaggedCount;
        }

        function toggleFlag(questionIndex) {
            console.log('toggleFlag called with questionIndex:', questionIndex);

            if (flaggedQuestions.has(questionIndex)) {
                flaggedQuestions.delete(questionIndex);
            } else {
                flaggedQuestions.add(questionIndex);
            }

            // Update UI - Find the current question card
            const currentQuestionCard = document.querySelector('.question-card[style*="block"]');
            console.log('Current question card found:', currentQuestionCard ? 'yes' : 'no');

            if (currentQuestionCard) {
                const flagButton = currentQuestionCard.querySelector('.btn-flag');
                console.log('Flag button found:', flagButton ? 'yes' : 'no');

                if (flagButton) {
                    flagButton.classList.toggle('flagged');
                    console.log('Flag button updated successfully');
                } else {
                    console.error('Flag button not found in current question card');
                }
            } else {
                console.error('Current question card not found');
            }

            // Update navigation item
            const navItem = document.querySelectorAll('.question-nav-item')[questionIndex];
            console.log('Nav item found:', navItem ? 'yes' : 'no');

            if (navItem) {
                navItem.classList.toggle('flagged');
                console.log('Nav item updated successfully');
            } else {
                console.error('Nav item not found for index:', questionIndex);
            }

            updateStats();
        }

        // Answer tracking
        function markQuestionAnswered(questionIndex) {
            answeredQuestions.add(questionIndex);
            const navItem = document.querySelectorAll('.question-nav-item')[questionIndex];
            navItem.classList.add('answered');
            updateStats();
        }

        // Render questions with improved UI
        async function renderQuestions(lesson) {
            if (!lesson || !lesson.questions || !Array.isArray(lesson.questions)) {
                console.warn('Lesson has no questions');
                return;
            }

            const container = document.getElementById('questions-container');
            const navGrid = document.getElementById('question-nav-grid');
            container.innerHTML = '';
            navGrid.innerHTML = '';

            // Process questions
            let allQuestions = [...lesson.questions];
            
            // Apply shuffle if enabled
            console.log('üé≤ Shuffle Debug - shuffleQuestions flag:', lesson.shuffleQuestions);
            console.log('üé≤ Shuffle Debug - Questions before shuffle:', allQuestions.map(q => q.question || q.id));
            
            // Check URL parameter for force shuffle
            const urlParams = new URLSearchParams(window.location.search);
            const forceShuffleQuestions = urlParams.get('shuffle') === 'true';
            
            if (lesson.shuffleQuestions || forceShuffleQuestions) {
                if (forceShuffleQuestions) {
                    console.log('üîß Force shuffle enabled via URL parameter');
                }
                allQuestions = shuffleArray(allQuestions);
                console.log('üé≤ Shuffle Debug - Questions after shuffle:', allQuestions.map(q => q.question || q.id));
            } else {
                console.warn('‚ö†Ô∏è Shuffle Debug - shuffleQuestions is false or undefined!');
                console.log('üí° Tip: Add ?shuffle=true to URL to force shuffling');
            }
            
            // Apply random selection if specified (legacy support)
            if (lesson.randomQuestions > 0 && lesson.randomQuestions < lesson.questions.length) {
                allQuestions = shuffleArray(allQuestions).slice(0, lesson.randomQuestions);
            }

            // Render each question
            allQuestions.forEach((q, displayIndex) => {
                const originalIndex = lesson.questions.indexOf(q);
                
                // Create navigation item
                const navItem = document.createElement('div');
                navItem.className = 'question-nav-item';
                navItem.textContent = displayIndex + 1;
                navItem.onclick = () => navigateToQuestion(displayIndex);
                navGrid.appendChild(navItem);

                // Create question card
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.dataset.questionIndex = originalIndex;
                questionCard.style.display = displayIndex === 0 ? 'block' : 'none';

                // Extract image if present
                let imageUrl = null;
                const imgRegex = /\[img\s+src="([^"]+)"\]/i;
                const match = q.question.match(imgRegex);
                if (match && match[1]) {
                    imageUrl = match[1];
                }
                let questionText = q.question;
                if (imageUrl) {
                    questionText = questionText.replace(imgRegex, '').trim();
                }

                let questionHtml = `
                    <div class="question-header">
                        <h3 class="question-number">C√¢u ${displayIndex + 1}</h3>
                        <div class="question-actions">
                            <button class="btn-flag" onclick="toggleFlag(${displayIndex})">
                                <i class="fas fa-flag"></i>
                                Xong
                            </button>
                        </div>
                    </div>
                `;

                // Add lesson image to first question only
                if (displayIndex === 0 && lesson.lessonImage) {
                    questionHtml += `
                        <div class="lesson-image-container">
                            <img src="${lesson.lessonImage}" alt="Lesson Image" class="lesson-image">
                        </div>
                    `;
                }

                questionHtml += `<div class="question-text">${questionText}</div>`;

                if (imageUrl) {
                    questionHtml += `
                        <div class="question-image-container">
                            <img src="${imageUrl}" alt="Question Image" class="question-image">
                        </div>
                    `;
                }

                // Render options based on question type
                // Handle both old format (multiple_choice) and new format (abcd)
                const normalizedType = q.type === 'multiple_choice' ? 'abcd' :
                                     q.type === 'true_false' ? 'truefalse' :
                                     q.type === 'fill_blank' ? 'number' : q.type;

                switch(normalizedType) {
                    case 'abcd':
                        // Ensure options exist and handle both string and object formats
                        if (!q.options || !Array.isArray(q.options)) {
                            console.warn('ABCD question missing options:', q);
                            questionHtml += '<div class="error-message">Error: No options available for this question</div>';
                            break;
                        }

                        const optionsWithIndices = q.options.map((option, idx) => ({
                            text: typeof option === 'string' ? option : (option.text || ''),
                            originalIndex: idx,
                            letter: String.fromCharCode(65 + idx)
                        }));
                        
                        // Only shuffle options if shuffleAnswers is enabled
                        const shuffledOptions = lesson.shuffleAnswers ? 
                            shuffleArray([...optionsWithIndices]) : 
                            optionsWithIndices;
                        
                        questionMappings[originalIndex] = shuffledOptions.map(
                            (opt, newIndex) => ({
                                displayedLetter: String.fromCharCode(65 + newIndex),
                                originalLetter: opt.letter,
                                originalIndex: opt.originalIndex
                            })
                        );

                        questionHtml += '<div class="options-container">';
                        shuffledOptions.forEach((option, idx) => {
                            const optionLetter = String.fromCharCode(65 + idx);
                            questionHtml += `
                                <div class="option-card" onclick="selectOption(${originalIndex}, '${optionLetter}', this)">
                                    <input type="radio" 
                                           id="q${originalIndex}_${idx}"
                                           name="q${originalIndex}" 
                                           value="${optionLetter}">
                                    <label for="q${originalIndex}_${idx}" class="option-label">
                                        <span class="option-letter">${optionLetter}</span>
                                        <span class="option-text">${option.text}</span>
                                    </label>
                                </div>
                            `;
                        });
                        questionHtml += '</div>';
                        break;

                    case 'truefalse':
                        if (Array.isArray(q.options) && q.options.length > 0) {
                            questionHtml += '<div class="truefalse-container">';
                            q.options.forEach((option, idx) => {
                                const optionText = typeof option === 'string' ? option : (option.text || '');
                                questionHtml += `
                                    <div class="truefalse-item">
                                        <div class="truefalse-text">${String.fromCharCode(65 + idx)}) ${optionText}</div>
                                        <div class="truefalse-buttons">
                                            <label class="truefalse-btn" onclick="selectTrueFalse(${originalIndex}, ${idx}, true, this)">
                                                <input type="radio"
                                                       name="q${originalIndex}_${idx}"
                                                       value="true">
                                                ƒê√∫ng
                                            </label>
                                            <label class="truefalse-btn" onclick="selectTrueFalse(${originalIndex}, ${idx}, false, this)">
                                                <input type="radio"
                                                       name="q${originalIndex}_${idx}"
                                                       value="false">
                                                Sai
                                            </label>
                                        </div>
                                    </div>
                                `;
                            });
                            questionHtml += '</div>';
                        } else {
                            console.warn('True/false question missing options:', q);
                            questionHtml += '<div class="error-message">Error: No options available for this true/false question</div>';
                        }
                        break;

                    case 'number':
                        questionHtml += `
                            <div class="number-input-container">
                                <input type="number" 
                                       name="q${originalIndex}" 
                                       class="modern-number-input"
                                       placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..."
                                       onchange="markQuestionAnswered(${displayIndex})"
                                       required>
                            </div>
                        `;
                        break;
                }

                questionCard.innerHTML = questionHtml;
                container.appendChild(questionCard);
            });

            // Initialize first question as active
            if (navGrid.firstChild) {
                navGrid.firstChild.classList.add('active');
            }

            // Initialize KaTeX rendering
            if (typeof renderMathInElement === 'function') {
                renderMathInElement(container, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false},
                        {left: "\\(", right: "\\)", display: false},
                        {left: "\\[", right: "\\]", display: true}
                    ],
                    throwOnError: false
                });
            }
        }

        // Option selection handlers
        function selectOption(questionIndex, value, element) {
            // Remove selected class from all options
            const allOptions = element.parentElement.querySelectorAll('.option-card');
            allOptions.forEach(opt => opt.classList.remove('selected'));
            
            // Add selected class to clicked option
            element.classList.add('selected');
            
            // Check the radio button
            const radio = element.querySelector('input[type="radio"]');
            radio.checked = true;
            
            // Mark question as answered
            const displayIndex = Array.from(document.querySelectorAll('.question-card'))
                .findIndex(card => card.dataset.questionIndex == questionIndex);
            markQuestionAnswered(displayIndex);
        }

        function selectTrueFalse(questionIndex, optionIndex, value, element) {
            // Remove selected class from both buttons
            const buttons = element.parentElement.querySelectorAll('.truefalse-btn');
            buttons.forEach(btn => {
                btn.classList.remove('selected-true', 'selected-false');
            });
            
            // Add appropriate class
            element.classList.add(value ? 'selected-true' : 'selected-false');
            
            // Check the radio button
            const radio = element.querySelector('input[type="radio"]');
            radio.checked = true;
            
            // Check if all options are answered for this question
            const questionCard = document.querySelector(`[data-question-index="${questionIndex}"]`);
            const allRadios = questionCard.querySelectorAll('input[type="radio"]');
            const checkedRadios = questionCard.querySelectorAll('input[type="radio"]:checked');
            
            if (allRadios.length / 2 === checkedRadios.length) {
                const displayIndex = Array.from(document.querySelectorAll('.question-card'))
                    .findIndex(card => card.dataset.questionIndex == questionIndex);
                markQuestionAnswered(displayIndex);
            }
        }

        // Submit confirmation
        function showConfirmationModal() {
            const modal = document.getElementById('confirmation-modal');
            const totalQuestions = document.querySelectorAll('.question-card').length;
            
            document.getElementById('modal-answered').textContent = answeredQuestions.size;
            document.getElementById('modal-unanswered').textContent = totalQuestions - answeredQuestions.size;
            document.getElementById('modal-flagged').textContent = flaggedQuestions.size;
            
            modal.classList.add('show');
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').classList.remove('show');

            // Reset confirmation button state when modal is closed
            const confirmButton = document.querySelector('.btn-confirm');
            if (confirmButton) {
                confirmButton.disabled = false;
                confirmButton.classList.remove('loading');
                confirmButton.innerHTML = 'N·ªôp b√†i';
            }
        }

        async function confirmSubmit() {
            const submitButton = document.getElementById('submit-quiz-btn');
            const confirmButton = document.querySelector('.btn-confirm');

            // Disable and show loading state for confirmation button
            confirmButton.disabled = true;
            confirmButton.classList.add('loading');
            confirmButton.innerHTML = `
                ƒêang n·ªôp<span class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </span>
            `;

            // Also disable the main submit button
            submitButton.disabled = true;
            submitButton.textContent = 'ƒêang n·ªôp b√†i...';

            try {
                // Continue with existing submit logic...
                await submitQuiz();
            } catch (error) {
                // Reset button state on error
                confirmButton.disabled = false;
                confirmButton.classList.remove('loading');
                confirmButton.innerHTML = 'N·ªôp b√†i';

                submitButton.disabled = false;
                submitButton.textContent = 'N·ªôp b√†i';

                throw error; // Re-throw to maintain error handling
            }
        }

        // Modified submit function
        async function submitQuiz() {
            try {
                // Get IP address
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                
                const lessonId = currentLessonData.id;
                const lesson = currentLessonData;
                
                let score = 0;
                let totalPossiblePoints = 0;
                const timeTaken = (Date.now() - startTime) / 1000;

                const quizResults = {
                    lessonId: lessonId,
                    questions: [],
                    ipAddress: ipData.ip,
                    submittedAt: new Date().toISOString(),
                    timeTaken: timeTaken
                };

                // Process all questions...
                const questionElements = document.querySelectorAll('.question-card');
                questionElements.forEach((questionElement) => {
                    const originalIndex = parseInt(questionElement.dataset.questionIndex);
                    const q = lesson.questions[originalIndex];
                    
                    const questionPoints = (typeof q.points === 'number' && q.points > 0) ? q.points : 1;
                    totalPossiblePoints += questionPoints;

                    let userAnswer, correctAnswer, isCorrect, optionsText = null;
                    let earnedPoints = undefined; // For True/False partial scoring
                    
                    // Extract image URL if present
                    let imageUrl = null;
                    const imgRegex = /\[img\s+src="([^"]+)"\]/i;
                    const originalQuestionText = lesson.questions[originalIndex].question;
                    const match = originalQuestionText.match(imgRegex);
                    if (match && match[1]) {
                        imageUrl = match[1];
                    }
                    
                    let questionTextForSaving = originalQuestionText;
                    if (imageUrl) {
                        questionTextForSaving = questionTextForSaving.replace(imgRegex, '').trim();
                    }

                    // Process answers based on question type
                    // Handle both old format (multiple_choice) and new format (abcd)
                    const normalizedType = q.type === 'multiple_choice' ? 'abcd' :
                                         q.type === 'true_false' ? 'truefalse' :
                                         q.type === 'fill_blank' ? 'number' : q.type;

                    // Get correct answer from either 'correct' or 'correctAnswer' property
                    const correctAnswerValue = q.correct !== undefined ? q.correct : q.correctAnswer;

                    if (normalizedType === 'truefalse' && Array.isArray(q.options)) {
                        const userAnswersArray = q.options.map((_, idx) => {
                            const selectedInput = document.querySelector(`input[name="q${originalIndex}_${idx}"]:checked`);
                            return selectedInput ? selectedInput.value === 'true' : null;
                        });

                        const correctAnswersArray = correctAnswerValue;
                        optionsText = q.options.map(opt => opt.text || opt);

                        // Count correct answers for partial scoring
                        let correctCount = 0;
                        if (Array.isArray(correctAnswersArray)) {
                            correctAnswersArray.forEach((correctAns, idx) => {
                                if (userAnswersArray[idx] !== null) {
                                    // Normalize both values to boolean for comparison
                                    const userBool = userAnswersArray[idx];
                                    let correctBool;

                                    // Handle different formats of correct answers
                                    if (typeof correctAns === 'boolean') {
                                        correctBool = correctAns;
                                    } else if (typeof correctAns === 'string') {
                                        correctBool = correctAns.toLowerCase() === 'true';
                                    } else {
                                        correctBool = Boolean(correctAns);
                                    }

                                    if (userBool === correctBool) {
                                        correctCount++;
                                    }
                                }
                            });
                        }

                        // Calculate partial score based on correct count
                        let partialMultiplier = 0;
                        const totalOptions = correctAnswersArray.length;

                        // For 4-option True/False questions
                        if (totalOptions === 4) {
                            if (correctCount === 4) {
                                partialMultiplier = 1.0; // 100%
                                isCorrect = true;
                            } else if (correctCount === 3) {
                                partialMultiplier = 0.5; // 50%
                                isCorrect = false; // Not fully correct
                            } else if (correctCount === 2) {
                                partialMultiplier = 0.25; // 25%
                                isCorrect = false;
                            } else if (correctCount === 1) {
                                partialMultiplier = 0.1; // 10%
                                isCorrect = false;
                            } else {
                                partialMultiplier = 0; // 0%
                                isCorrect = false;
                            }
                        } else {
                            // For True/False questions with different number of options
                            // Use proportional scoring
                            if (correctCount === totalOptions) {
                                partialMultiplier = 1.0; // 100% if all correct
                                isCorrect = true;
                            } else {
                                partialMultiplier = correctCount / totalOptions;
                                isCorrect = false;
                            }
                        }

                        // Apply partial scoring to points
                        earnedPoints = questionPoints * partialMultiplier;

                        // Debug logging for true/false questions (development only)
                        if (window.location.hostname === 'localhost' || window.location.hostname.includes('dev')) {
                            console.log(`üîç True/False Question ${originalIndex} (lesson.html):`, {
                                userAnswers: userAnswersArray,
                                correctAnswers: correctAnswersArray,
                                correctCount,
                                totalOptions,
                                partialMultiplier,
                                questionPoints,
                                earnedPoints
                            });
                        }

                        userAnswer = userAnswersArray;
                        correctAnswer = correctAnswersArray;
                    } else if (normalizedType === 'abcd') {
                        const selectedRadio = document.querySelector(`input[name="q${originalIndex}"]:checked`);
                        const selectedValue = selectedRadio ? selectedRadio.value : null;

                        if (Array.isArray(q.options)) {
                            optionsText = q.options.map(opt => opt.text || opt);
                        } else {
                            optionsText = [];
                        }

                        if (selectedValue) {
                            const mapping = questionMappings[originalIndex];
                            const selectedMapping = mapping ? mapping.find(m => m.displayedLetter === selectedValue) : null;
                            
                            if (selectedMapping && q.options[selectedMapping.originalIndex]) {
                                const option = q.options[selectedMapping.originalIndex];
                                userAnswer = option.text || option;
                                
                                const correctIndex = correctAnswerValue.toUpperCase().charCodeAt(0) - 65;
                                if (correctIndex >= 0 && correctIndex < q.options.length) {
                                    const correctOption = q.options[correctIndex];
                                    correctAnswer = correctOption.text || correctOption;
                                    isCorrect = selectedMapping.originalIndex === correctIndex;
                                } else {
                                    correctAnswer = 'Error: Invalid correct answer specified';
                                    isCorrect = false;
                                }
                            }
                        } else {
                            userAnswer = 'No answer';
                            const correctIndex = correctAnswerValue.toUpperCase().charCodeAt(0) - 65;
                            if (correctIndex >= 0 && correctIndex < q.options.length) {
                                const correctOption = q.options[correctIndex];
                                correctAnswer = correctOption.text || correctOption;
                            } else {
                                correctAnswer = 'Error: Invalid correct answer specified';
                            }
                            isCorrect = false;
                        }
                    } else if (q.type === 'number') {
                        const inputElement = document.querySelector(`[name="q${originalIndex}"]`);
                        userAnswer = inputElement ? inputElement.value : 'No input found';
                        correctAnswer = q.correct.toString();
                        isCorrect = userAnswer !== '' && userAnswer === correctAnswer;
                    }

                    // Handle earned points for True/False partial scoring
                    let finalEarnedPoints = isCorrect ? questionPoints : 0;

                    // Override earned points for True/False questions with partial scoring
                    if (normalizedType === 'truefalse' && Array.isArray(q.options) && typeof earnedPoints !== 'undefined') {
                        finalEarnedPoints = earnedPoints;
                        // Debug logging (development only)
                        if (window.location.hostname === 'localhost' || window.location.hostname.includes('dev')) {
                            console.log(`üîç True/False Final Points Override (lesson.html):`, {
                                originalFinalEarnedPoints: isCorrect ? questionPoints : 0,
                                overriddenFinalEarnedPoints: finalEarnedPoints,
                                earnedPoints,
                                isCorrect
                            });
                        }
                    }

                    quizResults.questions.push({
                        type: q.type,
                        question: questionTextForSaving,
                        imageUrl: imageUrl,
                        userAnswer: userAnswer,
                        correctAnswer: correctAnswer,
                        isCorrect: isCorrect,
                        points: questionPoints,
                        earnedPoints: finalEarnedPoints,
                        optionsText: optionsText
                    });

                    score += finalEarnedPoints;
                });
                
                quizResults.totalPoints = totalPossiblePoints;
                quizResults.score = score;

                // Submit results
                let studentInfo = { name: 'Anonymous Student' };
                try {
                    const authResponse = await fetch('/api/auth/student/check');
                    if (authResponse.ok) {
                        const authData = await authResponse.json();
                        if (authData.isAuthenticated && authData.student) {
                            studentInfo = {
                                name: authData.student.name,
                                id: authData.student.id
                            };
                        }
                    }
                } catch (authError) {
                    console.warn('Could not get student info:', authError);
                }

                const answers = Array.isArray(quizResults.questions) ? quizResults.questions : [];
                const resultPayload = {
                    lessonId: quizResults.lessonId,
                    answers: answers,
                    timeTaken: Number(quizResults.timeTaken) || 0,
                    studentInfo: studentInfo
                };

                // Get CSRF token before making the request
                const csrfResponse = await fetch('/api/csrf-token');
                if (!csrfResponse.ok) {
                    throw new Error('Failed to get CSRF token');
                }
                const csrfData = await csrfResponse.json();

                // Add CSRF token to the payload
                resultPayload.csrfToken = csrfData.csrfToken;

                const saveResponse = await window.encryptionClient.secureFetch('/api/results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(resultPayload)
                });

                if (!saveResponse.ok) {
                    const errorData = await saveResponse.json();
                    throw new Error(errorData.message || 'Failed to save results');
                }

                const resultData = await saveResponse.json();
                
                localStorage.setItem('quizResults', JSON.stringify({
                    lessonId: quizResults.lessonId,
                    score: quizResults.score,
                    totalPoints: quizResults.totalPoints,
                    resultId: resultData.resultId
                }));
                
                window.location.href = `/result/${resultData.resultId}`;

            } catch (error) {
                console.error('Error submitting quiz:', error);
                alert('ƒê√£ x·∫£y ra l·ªói khi n·ªôp b√†i. Vui l√≤ng th·ª≠ l·∫°i.');

                // Reset main submit button
                const submitButton = document.getElementById('submit-quiz-btn');
                submitButton.disabled = false;
                submitButton.textContent = 'N·ªôp b√†i';

                // Reset confirmation button
                const confirmButton = document.querySelector('.btn-confirm');
                if (confirmButton) {
                    confirmButton.disabled = false;
                    confirmButton.classList.remove('loading');
                    confirmButton.innerHTML = 'N·ªôp b√†i';
                }
            }
        }

        // Initialize lesson
        async function initializeLesson() {
            const isAuthenticated = await checkStudentAuthentication();
            
            showLoader(true);
            let lessonId = window.location.pathname.split('/')[2];
            document.title = 'Loading lesson...';
            
            try {
                let response;
                
                // Check if we're loading the last incomplete lesson
                if (lessonId === 'last-incomplete') {
                    response = await fetch('/api/lessons/last-incomplete');
                    if (!response.ok) {
                        throw new Error(`Failed to fetch last incomplete lesson: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    if (!result.lesson) {
                        // No incomplete lessons, redirect to lessons page
                        alert('Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ c√°c b√†i h·ªçc.');
                        window.location.href = '/lessons';
                        return;
                    }
                    
                    // Update the URL to show the actual lesson ID
                    lessonId = result.lesson.id;
                    window.history.replaceState({}, '', `/lesson/${lessonId}`);
                    
                    // Now fetch the full lesson data with encryption
                    response = await window.encryptionClient.secureFetch(`/api/lessons/${lessonId}`);
                } else {
                    response = await window.encryptionClient.secureFetch(`/api/lessons/${lessonId}`);
                }
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch lesson: ${response.status}`);
                }
                
                const responseData = await response.json();
                const lesson = responseData.lesson || responseData;
                currentLessonData = lesson;
                
                console.log('üìö Lesson loaded:', JSON.stringify(lesson, null, 2));
                console.log('üîç Debug - Shuffle flags:', {
                    shuffleQuestions: lesson.shuffleQuestions,
                    shuffleAnswers: lesson.shuffleAnswers,
                    randomQuestions: lesson.randomQuestions
                });

                if (lesson.error || responseData.error) {
                    document.body.innerHTML = '<h1>Lesson not found</h1>';
                    currentLessonData = null;
                    return;
                }
                
                document.title = lesson.title;
                const titleElement = document.getElementById('lesson-title');
                if (titleElement) {
                    titleElement.textContent = lesson.title;
                }
                
                await renderQuestions(lesson);
                showLoader(false);
                
                // Start timer
                startTimer();
                
                // Update initial stats
                updateStats();

            } catch (error) {
                console.error('Error loading lesson:', error);
                document.body.innerHTML = `
                    <h1>Error loading lesson</h1>
                    <p>Error details: ${error.message}</p>
                `;
                showLoader(false);
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const submitButton = document.getElementById('submit-quiz-btn');
            if (submitButton) {
                submitButton.addEventListener('click', async () => {
                    const isAuthenticated = await checkStudentAuthentication();
                    if (!isAuthenticated) {
                        promptForLogin();
                        return;
                    }

                    if (!currentLessonData) {
                        alert("L·ªói: D·ªØ li·ªáu b√†i h·ªçc ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng t·∫£i l·∫°i trang.");
                        return;
                    }
                    
                    showConfirmationModal();
                });
            }

            initializeLesson();
        });

        // Mobile sidebar toggle functions
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('exam-sidebar');
            const submitButton = document.getElementById('submit-quiz-btn');
            const isVisible = sidebar.classList.contains('show');
            
            if (isVisible) {
                sidebar.classList.remove('show');
                document.body.style.overflow = '';
                // Show submit button again
                if (submitButton) {
                    submitButton.style.display = 'flex';
                }
            } else {
                sidebar.classList.add('show');
                document.body.style.overflow = 'hidden';
                // Hide submit button when sidebar is open to prevent overlap
                if (submitButton) {
                    submitButton.style.display = 'none';
                }
            }
        }

        // Enhanced Image modal functions with zoom functionality
        function initializeImageZoom() {
            const questionImages = document.querySelectorAll('.question-image, .lesson-image');
            const imageModal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            const closeButton = document.getElementById('close-modal');
            const zoomInButton = document.getElementById('zoom-in');
            const zoomOutButton = document.getElementById('zoom-out');
            const resetZoomButton = document.getElementById('reset-zoom');

            // Zooming variables
            let scale = 1;
            let panning = false;
            let pointX = 0;
            let pointY = 0;
            let startX = 0;
            let startY = 0;

            // Open modal when any question image is clicked
            questionImages.forEach(function(image) {
                image.addEventListener('click', function() {
                    openModal(this);
                });
            });

            function openModal(imageElement) {
                modalImage.src = imageElement.src;
                modalImage.alt = imageElement.alt;
                imageModal.classList.add('open');
                document.body.style.overflow = 'hidden';
                resetZoom();
            }

            // Close modal when close button is clicked
            if (closeButton) {
                closeButton.addEventListener('click', closeModal);
            }

            // Close modal when clicking outside the image
            imageModal.addEventListener('click', function(e) {
                if (e.target === imageModal) {
                    closeModal();
                }
            });

            // Close modal when ESC key is pressed
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && imageModal.classList.contains('open')) {
                    closeModal();
                }
            });

            function closeModal() {
                imageModal.classList.remove('open');
                document.body.style.overflow = '';
                resetZoom();
            }

            // Zoom controls
            if (zoomInButton) {
                zoomInButton.addEventListener('click', function() {
                    setZoom(scale + 0.5);
                });
            }

            if (zoomOutButton) {
                zoomOutButton.addEventListener('click', function() {
                    setZoom(Math.max(1, scale - 0.5));
                });
            }

            if (resetZoomButton) {
                resetZoomButton.addEventListener('click', resetZoom);
            }

            function resetZoom() {
                scale = 1;
                pointX = 0;
                pointY = 0;
                modalImage.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
            }

            function setZoom(newScale) {
                scale = newScale;
                modalImage.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
            }

            // Mouse wheel zoom
            modalImage.addEventListener('wheel', function(e) {
                e.preventDefault();
                const xs = (e.clientX - pointX) / scale;
                const ys = (e.clientY - pointY) / scale;

                if (e.deltaY < 0) {
                    scale *= 1.1;
                } else {
                    scale /= 1.1;
                }

                scale = Math.max(1, scale);

                pointX = e.clientX - xs * scale;
                pointY = e.clientY - ys * scale;

                modalImage.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
            });

            // Drag to pan
            modalImage.addEventListener('mousedown', function(e) {
                e.preventDefault();

                if (scale > 1) {
                    panning = true;
                    startX = e.clientX - pointX;
                    startY = e.clientY - pointY;
                }
            });

            imageModal.addEventListener('mousemove', function(e) {
                e.preventDefault();

                if (panning && scale > 1) {
                    pointX = e.clientX - startX;
                    pointY = e.clientY - startY;
                    modalImage.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
                }
            });

            imageModal.addEventListener('mouseup', function(e) {
                panning = false;
            });

            imageModal.addEventListener('mouseleave', function(e) {
                panning = false;
            });

            // Touch support for mobile devices
            let evCache = [];
            let prevDiff = -1;

            modalImage.addEventListener('touchstart', function(e) {
                for (let i = 0; i < e.touches.length; i++) {
                    evCache.push({
                        identifier: e.touches[i].identifier,
                        clientX: e.touches[i].clientX,
                        clientY: e.touches[i].clientY
                    });
                }

                if (e.touches.length === 1 && scale > 1) {
                    panning = true;
                    startX = e.touches[0].clientX - pointX;
                    startY = e.touches[0].clientY - pointY;
                }
            });

            modalImage.addEventListener('touchmove', function(e) {
                for (let i = 0; i < e.touches.length; i++) {
                    const idx = evCache.findIndex(cachedTouch =>
                        cachedTouch.identifier === e.touches[i].identifier
                    );
                    if (idx >= 0) {
                        evCache[idx].clientX = e.touches[i].clientX;
                        evCache[idx].clientY = e.touches[i].clientY;
                    }
                }

                if (e.touches.length === 2) {
                    const curDiff = Math.abs(evCache[0].clientX - evCache[1].clientX);

                    if (prevDiff > 0) {
                        if (curDiff > prevDiff) {
                            scale *= 1.05;
                        } else if (curDiff < prevDiff) {
                            scale /= 1.05;
                        }
                        scale = Math.max(1, scale);
                        modalImage.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
                    }

                    prevDiff = curDiff;
                } else if (e.touches.length === 1 && panning && scale > 1) {
                    pointX = e.touches[0].clientX - startX;
                    pointY = e.touches[0].clientY - startY;
                    modalImage.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
                }
            });

            modalImage.addEventListener('touchend', function(e) {
                for (let i = 0; i < e.changedTouches.length; i++) {
                    const idx = evCache.findIndex(cachedTouch =>
                        cachedTouch.identifier === e.changedTouches[i].identifier
                    );
                    if (idx >= 0) {
                        evCache.splice(idx, 1);
                    }
                }

                if (evCache.length < 2) {
                    prevDiff = -1;
                }

                if (e.touches.length === 0) {
                    panning = false;
                }
            });

            // Prevent default touchmove behavior
            modalImage.addEventListener('touchmove', function(e) {
                if (e.touches.length > 1 || (scale > 1 && e.touches.length === 1)) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        // Legacy function for backward compatibility
        function openImageModal(imageSrc) {
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            modalImage.src = imageSrc;
            modal.classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('image-modal');
            modal.classList.remove('open');
            document.body.style.overflow = '';
        }

        // Zoom management
        const zoomLevels = [0.75, 0.8, 0.9, 1, 1.1, 1.25];
        let currentZoomIndex = 3; // Default to 100% (1.0)

        function initializeZoom() {
            // Load saved zoom level from localStorage
            const savedZoomLevel = localStorage.getItem('lessonZoomLevel');
            if (savedZoomLevel) {
                const savedZoom = parseFloat(savedZoomLevel);
                const savedIndex = zoomLevels.indexOf(savedZoom);
                if (savedIndex !== -1) {
                    currentZoomIndex = savedIndex;
                    applyZoom(savedZoom);
                }
            } else {
                // Set default zoom
                applyZoom(zoomLevels[currentZoomIndex]);
            }

            // Update zoom label
            updateZoomLabel();
        }

        function changeZoom(delta) {
            let newIndex;
            
            // Handle reset to normal (delta = 0)
            if (delta === 0) {
                newIndex = 3; // 100% zoom
            } else {
                newIndex = currentZoomIndex + delta;
                
                // Check bounds
                if (newIndex < 0 || newIndex >= zoomLevels.length) {
                    // Provide visual feedback that we've reached the limit
                    const button = delta > 0 ? document.getElementById('increase-zoom') : document.getElementById('decrease-zoom');
                    if (button) {
                        button.style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            button.style.transform = '';
                        }, 200);
                    }
                    return;
                }
            }

            // Apply new zoom
            currentZoomIndex = newIndex;
            const newZoomLevel = zoomLevels[currentZoomIndex];
            applyZoom(newZoomLevel);
            
            // Save to localStorage
            localStorage.setItem('lessonZoomLevel', newZoomLevel.toString());
            
            // Update label
            updateZoomLabel();

            // Animate the change
            animateZoomChange();
        }

        function applyZoom(zoomLevel) {
            const container = document.querySelector('.exam-container');
            if (container) {
                // Set transform origin to top left to prevent content shifting
                container.style.transformOrigin = 'top left';
                container.style.transform = `scale(${zoomLevel})`;
                
                // Add/remove zoomed-out class for mobile fixes
                if (zoomLevel < 1) {
                    document.body.classList.add('zoomed-out');
                } else {
                    document.body.classList.remove('zoomed-out');
                }
                
                // On mobile, handle zoom differently
                if (window.innerWidth <= 768) {
                    if (zoomLevel < 1) {
                        // For zoom out on mobile, adjust layout to prevent empty space
                        container.style.width = '100vw';
                        container.style.height = 'auto';
                        container.style.minHeight = '100vh';
                        
                        // Reset body overflow
                        document.body.style.overflow = 'auto';
                        
                        // Ensure content wrapper fills width
                        const contentWrapper = document.querySelector('.content-wrapper');
                        if (contentWrapper) {
                            contentWrapper.style.maxWidth = 'none';
                            contentWrapper.style.width = '100%';
                        }
                    } else {
                        // Normal or zoom in
                        container.style.width = `${100 / zoomLevel}%`;
                        container.style.height = `${100 / zoomLevel}vh`;
                    }
                } else {
                    // Desktop behavior remains the same
                    if (zoomLevel !== 1) {
                        container.style.width = `${100 / zoomLevel}%`;
                        container.style.height = `${100 / zoomLevel}vh`;
                    } else {
                        container.style.width = '100%';
                        container.style.height = '100vh';
                    }
                }
                
                // Scale floating buttons inversely
                const mobileToggle = document.getElementById('mobile-sidebar-toggle');
                const submitButton = document.getElementById('submit-quiz-btn');
                
                if (mobileToggle) {
                    mobileToggle.style.transform = `scale(${1 / zoomLevel})`;
                    mobileToggle.style.transformOrigin = 'top left';
                }
                
                if (submitButton) {
                    submitButton.style.transform = `scale(${1 / zoomLevel})`;
                    submitButton.style.transformOrigin = 'top right';
                }
            }
        }

        function updateZoomLabel() {
            const label = document.getElementById('zoom-percentage');
            if (label) {
                const percentage = Math.round(zoomLevels[currentZoomIndex] * 100);
                label.textContent = `${percentage}%`;
            }

            // Update button states
            const decreaseBtn = document.getElementById('decrease-zoom');
            const increaseBtn = document.getElementById('increase-zoom');
            
            if (decreaseBtn) {
                decreaseBtn.disabled = currentZoomIndex === 0;
                decreaseBtn.style.opacity = currentZoomIndex === 0 ? '0.5' : '1';
                decreaseBtn.style.cursor = currentZoomIndex === 0 ? 'not-allowed' : 'pointer';
            }
            
            if (increaseBtn) {
                increaseBtn.disabled = currentZoomIndex === zoomLevels.length - 1;
                increaseBtn.style.opacity = currentZoomIndex === zoomLevels.length - 1 ? '0.5' : '1';
                increaseBtn.style.cursor = currentZoomIndex === zoomLevels.length - 1 ? 'not-allowed' : 'pointer';
            }
        }

        function animateZoomChange() {
            const controls = document.querySelector('.zoom-controls-sidebar');
            if (controls) {
                controls.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    controls.style.transform = '';
                }, 200);
            }
        }

        // Event listeners for mobile functionality
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize zoom
            initializeZoom();

            // Zoom controls
            const decreaseBtn = document.getElementById('decrease-zoom');
            const increaseBtn = document.getElementById('increase-zoom');
            const resetBtn = document.getElementById('reset-zoom');

            if (decreaseBtn) {
                decreaseBtn.addEventListener('click', () => changeZoom(-1));
            }

            if (increaseBtn) {
                increaseBtn.addEventListener('click', () => changeZoom(1));
            }

            if (resetBtn) {
                resetBtn.addEventListener('click', () => changeZoom(0));
            }

            // Mobile sidebar toggle
            const mobileToggle = document.getElementById('mobile-sidebar-toggle');

            if (mobileToggle) {
                mobileToggle.addEventListener('click', toggleMobileSidebar);
            }

            // Initialize enhanced image zoom functionality
            initializeImageZoom();
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' && currentQuestionIndex > 0) {
                navigateQuestion(-1);
            } else if (e.key === 'ArrowRight' && currentQuestionIndex < document.querySelectorAll('.question-card').length - 1) {
                navigateQuestion(1);
            } else if (e.ctrlKey && e.key === '+') {
                // Ctrl + Plus: Zoom in
                e.preventDefault();
                changeZoom(1);
            } else if (e.ctrlKey && e.key === '-') {
                // Ctrl + Minus: Zoom out
                e.preventDefault();
                changeZoom(-1);
            } else if (e.ctrlKey && e.key === '0') {
                // Ctrl + 0: Reset to 100% zoom
                e.preventDefault();
                changeZoom(0);
            }
        });
    </script>
    
    <!-- Load external lesson.js file with cache busting -->
    <script src="/js/lesson.js?v=1.1"></script>
</body>
</html>