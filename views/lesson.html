<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Bài thi - Ôn luyện Vật lí</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Dark theme colors */
            --bg-primary: #0f0f14;
            --bg-secondary: #1a1a24;
            --bg-tertiary: #252533;
            --bg-card: #1e1e2a;
            --bg-card-hover: #262635;
            
            /* Text colors */
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --text-tertiary: #71717a;
            
            /* Accent colors */
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            
            /* Borders */
            --border-color: #2a2a3a;
            --border-focus: #6366f1;
            
            /* Spacing */
            --space-xs: 0.5rem;
            --space-sm: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2rem;
            --space-xl: 3rem;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
        }

        /* Loading Indicator */
        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Main Layout */
        .exam-container {
            display: flex;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar Navigation */
        .exam-sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .exam-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-color);
        }

        .exam-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
        }

        .exam-timer {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 1.125rem;
            color: var(--accent-warning);
            font-weight: 500;
        }

        /* Question Navigation */
        .question-nav {
            padding: var(--space-md);
        }

        .question-nav-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .question-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-xs);
        }

        .question-nav-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .question-nav-item:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
        }

        .question-nav-item.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .question-nav-item.answered {
            background: var(--bg-tertiary);
            border-color: var(--accent-success);
        }

        .question-nav-item.flagged::after {
            content: '';
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background: var(--accent-warning);
            border-radius: 50%;
        }

        /* Progress Stats */
        .exam-stats {
            padding: var(--space-md);
            border-top: 1px solid var(--border-color);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
            font-size: 0.875rem;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Main Content Area */
        .exam-content {
            flex: 1;
            overflow-y: auto;
            background: var(--bg-primary);
        }

        .content-wrapper {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--space-lg) var(--space-xl);
        }

        /* Question Card */
        .question-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }

        .question-number {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .question-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .btn-flag {
            padding: var(--space-xs) var(--space-sm);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .btn-flag:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-warning);
            color: var(--accent-warning);
        }

        .btn-flag.flagged {
            background: var(--accent-warning);
            border-color: var(--accent-warning);
            color: white;
        }

        .question-text {
            font-size: 1.125rem;
            line-height: 1.7;
            color: var(--text-primary);
            margin-bottom: var(--space-md);
        }

        .question-image-container {
            margin-bottom: var(--space-md);
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .lesson-image-container {
            margin-bottom: var(--space-lg);
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--space-md);
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .question-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            cursor: zoom-in;
            transition: opacity 0.3s;
            display: block;
        }

        .lesson-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            cursor: zoom-in;
            transition: opacity 0.3s;
            display: block;
        }

        .question-image:hover,
        .lesson-image:hover {
            opacity: 0.9;
        }

        /* Multiple Choice Options */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .option-card {
            position: relative;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: var(--space-md);
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .option-card input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .option-card.selected {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .option-label {
            display: flex;
            align-items: flex-start;
            gap: var(--space-sm);
            cursor: pointer;
            width: 100%;
        }

        .option-letter {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border-radius: 50%;
            font-weight: 600;
            transition: all 0.2s;
        }

        .option-card.selected .option-letter {
            background: white;
            color: var(--accent-primary);
        }

        .option-text {
            flex: 1;
            line-height: 1.6;
        }

        /* True/False Options */
        .truefalse-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .truefalse-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: var(--space-lg);
            align-items: center;
            padding: var(--space-md);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .truefalse-text {
            color: var(--text-primary);
            line-height: 1.6;
        }

        .truefalse-buttons {
            display: flex;
            gap: var(--space-sm);
        }

        .truefalse-btn {
            position: relative;
            padding: var(--space-xs) var(--space-md);
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .truefalse-btn input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .truefalse-btn:hover {
            border-color: var(--accent-primary);
        }

        .truefalse-btn.selected-true {
            background: var(--accent-success);
            border-color: var(--accent-success);
            color: white;
        }

        .truefalse-btn.selected-false {
            background: var(--accent-danger);
            border-color: var(--accent-danger);
            color: white;
        }

        /* Number Input */
        .number-input-container {
            max-width: 300px;
        }

        .modern-number-input {
            width: 100%;
            padding: var(--space-md);
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .modern-number-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Navigation Buttons */
        .navigation-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-lg);
            padding-top: var(--space-lg);
            border-top: 1px solid var(--border-color);
        }

        .nav-button {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-lg);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .nav-button:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .submit-button {
            padding: var(--space-sm) var(--space-xl);
            background: var(--accent-primary);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .submit-button:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .submit-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Floating Submit Button */
        .floating-submit-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: var(--space-sm) var(--space-lg);
            background: var(--accent-primary);
            border: none;
            border-radius: 50px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            min-width: auto;
        }

        .floating-submit-button:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(99, 102, 241, 0.4);
        }

        .floating-submit-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .floating-submit-button i {
            font-size: 0.9rem;
        }

        /* Mobile Sidebar Toggle */
        .mobile-sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            z-index: 1001;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .mobile-sidebar-toggle:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .mobile-sidebar-toggle:active {
            transform: scale(0.95);
        }

        /* Sidebar Overlay for Mobile */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .sidebar-overlay.show {
            display: block;
            opacity: 1;
        }

        /* Image Modal */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            cursor: zoom-out;
        }

        .image-modal.show {
            display: flex;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            cursor: zoom-out;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .image-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Confirmation Modal */
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .confirmation-modal.show {
            display: flex;
        }

        .confirmation-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: var(--space-xl);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .confirmation-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: var(--space-md);
            color: var(--text-primary);
        }

        .confirmation-message {
            color: var(--text-secondary);
            margin-bottom: var(--space-lg);
            line-height: 1.6;
        }

        .confirmation-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            padding: var(--space-md);
            background: var(--bg-card);
            border-radius: 8px;
        }

        .confirmation-stat {
            text-align: center;
        }

        .confirmation-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .confirmation-stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .confirmation-actions {
            display: flex;
            gap: var(--space-md);
            justify-content: center;
        }

        .btn-cancel {
            padding: var(--space-sm) var(--space-xl);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-cancel:hover {
            background: var(--bg-card-hover);
        }

        .btn-confirm {
            padding: var(--space-sm) var(--space-xl);
            background: var(--accent-primary);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .btn-confirm:hover {
            background: var(--accent-secondary);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .exam-sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease;
            }

            .exam-sidebar.show {
                left: 0;
            }

            .mobile-sidebar-toggle {
                display: flex !important;
            }

            .floating-submit-button {
                top: 20px;
                right: 15px;
                padding: 12px 20px;
                font-size: 0.9rem;
            }

            .content-wrapper {
                padding: var(--space-md);
                padding-top: 80px;
            }

            .question-card {
                padding: var(--space-lg);
                margin-bottom: var(--space-md);
            }

            .question-text {
                font-size: 1.1rem;
                line-height: 1.7;
            }

            .option-text {
                font-size: 1rem;
                line-height: 1.5;
            }

            .option-card {
                padding: var(--space-md) var(--space-sm);
            }

            .truefalse-item {
                grid-template-columns: 1fr;
                gap: var(--space-sm);
                padding: var(--space-md);
            }

            .truefalse-text {
                font-size: 1rem;
                line-height: 1.6;
            }

            .truefalse-buttons {
                justify-content: flex-start;
            }

            .truefalse-btn {
                padding: var(--space-sm) var(--space-md);
                font-size: 0.95rem;
            }

            .modern-number-input {
                font-size: 1.1rem;
                padding: var(--space-md);
            }

            .lesson-image {
                max-height: 250px;
            }

            .question-image {
                max-height: 300px;
            }

            .question-number {
                font-size: 1.2rem;
            }

            .btn-flag {
                padding: var(--space-xs) var(--space-sm);
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .floating-submit-button {
                padding: 10px 16px;
                font-size: 0.85rem;
                top: 15px;
                right: 15px;
            }

            .mobile-sidebar-toggle {
                width: 45px;
                height: 45px;
                top: 15px;
                left: 15px;
                font-size: 1.1rem;
            }

            .content-wrapper {
                padding: var(--space-sm);
                padding-top: 75px;
            }

            .question-card {
                padding: var(--space-md);
            }

            .question-text {
                font-size: 1.05rem;
            }

            .option-text {
                font-size: 0.95rem;
            }

            .lesson-image-container {
                padding: var(--space-sm);
            }

            .lesson-image {
                max-height: 200px;
            }

            .question-image {
                max-height: 250px;
            }
        }
        
        /* Practice Mode Indicator */
        .practice-mode-indicator {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: var(--space-sm) var(--space-lg);
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            font-weight: 500;
            margin-top: var(--space-sm);
            margin-bottom: var(--space-md);
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .practice-mode-indicator i {
            font-size: 1.25rem;
        }
        
        /* Countdown Timer Animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Loading Indicator -->
    <div id="loading-indicator" class="loading-indicator">
        <div class="spinner"></div>
        <p>Đang tải bài thi...</p>
    </div>

    <!-- Floating Submit Button -->
    <button class="floating-submit-button" id="submit-quiz-btn">
        <i class="fas fa-paper-plane"></i>
        Nộp bài
    </button>

    <!-- Mobile Sidebar Toggle -->
    <button class="mobile-sidebar-toggle" id="mobile-sidebar-toggle" style="display: none;">
        <i class="fas fa-bars"></i>
    </button>

    <div class="exam-container">
        <!-- Sidebar -->
        <aside class="exam-sidebar" id="exam-sidebar">
            <div class="exam-header">
                <h2 class="exam-title" id="lesson-title">Đang tải...</h2>
                <div class="exam-timer">
                    <i class="fas fa-clock"></i>
                    <span id="timer">00:00:00</span>
                </div>
            </div>

            <div class="question-nav">
                <h3 class="question-nav-title">Điều hướng câu hỏi</h3>
                <div class="question-grid" id="question-nav-grid">
                    <!-- Question navigation buttons will be generated here -->
                </div>
            </div>

            <div class="exam-stats">
                <div class="stat-item">
                    <span class="stat-label">Đã trả lời</span>
                    <span class="stat-value" id="answered-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Chưa trả lời</span>
                    <span class="stat-value" id="unanswered-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Đã đánh dấu</span>
                    <span class="stat-value" id="flagged-count">0</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="exam-content">
            <div class="content-wrapper">
                <div id="questions-container">
                    <!-- Questions will be dynamically inserted here -->
                </div>

                <div class="navigation-container">
                    <button class="nav-button" id="prev-button" onclick="navigateQuestion(-1)">
                        <i class="fas fa-chevron-left"></i>
                        Câu trước
                    </button>
                    
                    <button class="nav-button" id="next-button" onclick="navigateQuestion(1)">
                        Câu sau
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Image Modal -->
    <div class="image-modal" id="image-modal">
        <button class="image-modal-close" onclick="closeImageModal()">
            <i class="fas fa-times"></i>
        </button>
        <img id="modal-image" src="" alt="Full size image">
    </div>

    <!-- Confirmation Modal -->
    <div class="confirmation-modal" id="confirmation-modal">
        <div class="confirmation-content">
            <h3 class="confirmation-title">Xác nhận nộp bài</h3>
            <p class="confirmation-message">
                Bạn có chắc chắn muốn nộp bài không? Sau khi nộp, bạn không thể thay đổi câu trả lời.
            </p>
            <div class="confirmation-stats">
                <div class="confirmation-stat">
                    <div class="confirmation-stat-value" id="modal-answered">0</div>
                    <div class="confirmation-stat-label">Đã trả lời</div>
                </div>
                <div class="confirmation-stat">
                    <div class="confirmation-stat-value" id="modal-unanswered">0</div>
                    <div class="confirmation-stat-label">Chưa trả lời</div>
                </div>
                <div class="confirmation-stat">
                    <div class="confirmation-stat-value" id="modal-flagged">0</div>
                    <div class="confirmation-stat-label">Đã đánh dấu</div>
                </div>
            </div>
            <div class="confirmation-actions">
                <button class="btn-cancel" onclick="closeConfirmationModal()">Quay lại</button>
                <button class="btn-confirm" onclick="confirmSubmit()">Nộp bài</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <script>
        // Global variables
        let currentQuestionIndex = 0;
        let currentLessonData = null;
        let questionMappings = {};
        let answeredQuestions = new Set();
        let flaggedQuestions = new Set();
        let startTime = Date.now();
        let timerInterval = null;

        // Timer function
        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        // Authentication functions
        async function checkStudentAuthentication() {
            try {
                const response = await fetch('/api/auth/student/check');
                if (!response.ok) {
                    console.log('Auth check failed, user not authenticated');
                    return false;
                }
                const authData = await response.json();

                // Handle nested response structure
                if (authData.success && authData.data) {
                    if (authData.data.isAuthenticated && authData.data.student) {
                        console.log('Student authenticated:', authData.data.student.name);
                        return true;
                    }
                }
                
                console.log('Student not authenticated');
                return false;
            } catch (error) {
                console.error('Error checking student authentication:', error);
                return false;
            }
        }

        function promptForLogin() {
            const currentUrl = window.location.pathname + window.location.search;
            if (confirm('Bạn cần đăng nhập để làm bài tập. Chuyển đến trang đăng nhập?')) {
                window.location.href = '/student/login?redirect=' + encodeURIComponent(currentUrl);
            }
        }

        // Utility functions
        function showLoader(show) {
            const loader = document.getElementById('loading-indicator');
            if (loader) {
                loader.style.display = show ? 'flex' : 'none';
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Question navigation
        function navigateToQuestion(index) {
            const questions = document.querySelectorAll('.question-card');
            if (index >= 0 && index < questions.length) {
                // Hide all questions
                questions.forEach(q => q.style.display = 'none');
                
                // Show selected question
                questions[index].style.display = 'block';
                currentQuestionIndex = index;
                
                // Update navigation state
                updateNavigationState();
                
                // Scroll to top
                document.querySelector('.exam-content').scrollTop = 0;
            }
        }

        function navigateQuestion(direction) {
            navigateToQuestion(currentQuestionIndex + direction);
        }

        function updateNavigationState() {
            // Update nav buttons in sidebar
            const navItems = document.querySelectorAll('.question-nav-item');
            navItems.forEach((item, index) => {
                item.classList.toggle('active', index === currentQuestionIndex);
            });

            // Update prev/next buttons
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            const totalQuestions = document.querySelectorAll('.question-card').length;
            
            prevButton.disabled = currentQuestionIndex === 0;
            nextButton.disabled = currentQuestionIndex === totalQuestions - 1;

            // Update stats
            updateStats();
        }

        function updateStats() {
            const totalQuestions = document.querySelectorAll('.question-card').length;
            const answeredCount = answeredQuestions.size;
            const unansweredCount = totalQuestions - answeredCount;
            const flaggedCount = flaggedQuestions.size;

            document.getElementById('answered-count').textContent = answeredCount;
            document.getElementById('unanswered-count').textContent = unansweredCount;
            document.getElementById('flagged-count').textContent = flaggedCount;
        }

        function toggleFlag(questionIndex) {
            console.log('toggleFlag called with questionIndex:', questionIndex);

            if (flaggedQuestions.has(questionIndex)) {
                flaggedQuestions.delete(questionIndex);
            } else {
                flaggedQuestions.add(questionIndex);
            }

            // Update UI - Find the current question card
            const currentQuestionCard = document.querySelector('.question-card[style*="block"]');
            console.log('Current question card found:', currentQuestionCard ? 'yes' : 'no');

            if (currentQuestionCard) {
                const flagButton = currentQuestionCard.querySelector('.btn-flag');
                console.log('Flag button found:', flagButton ? 'yes' : 'no');

                if (flagButton) {
                    flagButton.classList.toggle('flagged');
                    console.log('Flag button updated successfully');
                } else {
                    console.error('Flag button not found in current question card');
                }
            } else {
                console.error('Current question card not found');
            }

            // Update navigation item
            const navItem = document.querySelectorAll('.question-nav-item')[questionIndex];
            console.log('Nav item found:', navItem ? 'yes' : 'no');

            if (navItem) {
                navItem.classList.toggle('flagged');
                console.log('Nav item updated successfully');
            } else {
                console.error('Nav item not found for index:', questionIndex);
            }

            updateStats();
        }

        // Answer tracking
        function markQuestionAnswered(questionIndex) {
            answeredQuestions.add(questionIndex);
            const navItem = document.querySelectorAll('.question-nav-item')[questionIndex];
            navItem.classList.add('answered');
            updateStats();
        }

        // Render questions with improved UI
        async function renderQuestions(lesson) {
            if (!lesson || !lesson.questions || !Array.isArray(lesson.questions)) {
                console.warn('Lesson has no questions');
                return;
            }

            const container = document.getElementById('questions-container');
            const navGrid = document.getElementById('question-nav-grid');
            container.innerHTML = '';
            navGrid.innerHTML = '';

            // Process questions
            let allQuestions = [...lesson.questions];
            
            // Apply random selection if specified
            if (lesson.randomQuestions > 0 && lesson.randomQuestions < lesson.questions.length) {
                allQuestions = shuffleArray(allQuestions).slice(0, lesson.randomQuestions);
            }

            // Render each question
            allQuestions.forEach((q, displayIndex) => {
                const originalIndex = lesson.questions.indexOf(q);
                
                // Create navigation item
                const navItem = document.createElement('div');
                navItem.className = 'question-nav-item';
                navItem.textContent = displayIndex + 1;
                navItem.onclick = () => navigateToQuestion(displayIndex);
                navGrid.appendChild(navItem);

                // Create question card
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.dataset.questionIndex = originalIndex;
                questionCard.style.display = displayIndex === 0 ? 'block' : 'none';

                // Extract image if present
                let imageUrl = null;
                const imgRegex = /\[img\s+src="([^"]+)"\]/i;
                const match = q.question.match(imgRegex);
                if (match && match[1]) {
                    imageUrl = match[1];
                }
                let questionText = q.question;
                if (imageUrl) {
                    questionText = questionText.replace(imgRegex, '').trim();
                }

                let questionHtml = `
                    <div class="question-header">
                        <h3 class="question-number">Câu ${displayIndex + 1}</h3>
                        <div class="question-actions">
                            <button class="btn-flag" onclick="toggleFlag(${displayIndex})">
                                <i class="fas fa-flag"></i>
                                Đánh dấu
                            </button>
                        </div>
                    </div>
                `;

                // Add lesson image to first question only
                if (displayIndex === 0 && lesson.lessonImage) {
                    questionHtml += `
                        <div class="lesson-image-container">
                            <img src="${lesson.lessonImage}" alt="Lesson Image" class="lesson-image" onclick="openImageModal('${lesson.lessonImage}')">
                        </div>
                    `;
                }

                questionHtml += `<div class="question-text">${questionText}</div>`;

                if (imageUrl) {
                    questionHtml += `
                        <div class="question-image-container">
                            <img src="${imageUrl}" alt="Question Image" class="question-image" onclick="openImageModal('${imageUrl}')">
                        </div>
                    `;
                }

                // Render options based on question type
                // Handle both old format (multiple_choice) and new format (abcd)
                const normalizedType = q.type === 'multiple_choice' ? 'abcd' :
                                     q.type === 'true_false' ? 'truefalse' :
                                     q.type === 'fill_blank' ? 'number' : q.type;

                switch(normalizedType) {
                    case 'abcd':
                        // Ensure options exist and handle both string and object formats
                        if (!q.options || !Array.isArray(q.options)) {
                            console.warn('ABCD question missing options:', q);
                            questionHtml += '<div class="error-message">Error: No options available for this question</div>';
                            break;
                        }

                        const optionsWithIndices = q.options.map((option, idx) => ({
                            text: typeof option === 'string' ? option : (option.text || ''),
                            originalIndex: idx,
                            letter: String.fromCharCode(65 + idx)
                        }));
                        const shuffledOptions = shuffleArray([...optionsWithIndices]);
                        
                        questionMappings[originalIndex] = shuffledOptions.map(
                            (opt, newIndex) => ({
                                displayedLetter: String.fromCharCode(65 + newIndex),
                                originalLetter: opt.letter,
                                originalIndex: opt.originalIndex
                            })
                        );

                        questionHtml += '<div class="options-container">';
                        shuffledOptions.forEach((option, idx) => {
                            const optionLetter = String.fromCharCode(65 + idx);
                            questionHtml += `
                                <div class="option-card" onclick="selectOption(${originalIndex}, '${optionLetter}', this)">
                                    <input type="radio" 
                                           id="q${originalIndex}_${idx}"
                                           name="q${originalIndex}" 
                                           value="${optionLetter}">
                                    <label for="q${originalIndex}_${idx}" class="option-label">
                                        <span class="option-letter">${optionLetter}</span>
                                        <span class="option-text">${option.text}</span>
                                    </label>
                                </div>
                            `;
                        });
                        questionHtml += '</div>';
                        break;

                    case 'truefalse':
                        if (Array.isArray(q.options) && q.options.length > 0) {
                            questionHtml += '<div class="truefalse-container">';
                            q.options.forEach((option, idx) => {
                                const optionText = typeof option === 'string' ? option : (option.text || '');
                                questionHtml += `
                                    <div class="truefalse-item">
                                        <div class="truefalse-text">${String.fromCharCode(65 + idx)}) ${optionText}</div>
                                        <div class="truefalse-buttons">
                                            <label class="truefalse-btn" onclick="selectTrueFalse(${originalIndex}, ${idx}, true, this)">
                                                <input type="radio"
                                                       name="q${originalIndex}_${idx}"
                                                       value="true">
                                                Đúng
                                            </label>
                                            <label class="truefalse-btn" onclick="selectTrueFalse(${originalIndex}, ${idx}, false, this)">
                                                <input type="radio"
                                                       name="q${originalIndex}_${idx}"
                                                       value="false">
                                                Sai
                                            </label>
                                        </div>
                                    </div>
                                `;
                            });
                            questionHtml += '</div>';
                        } else {
                            console.warn('True/false question missing options:', q);
                            questionHtml += '<div class="error-message">Error: No options available for this true/false question</div>';
                        }
                        break;

                    case 'number':
                        questionHtml += `
                            <div class="number-input-container">
                                <input type="number" 
                                       name="q${originalIndex}" 
                                       class="modern-number-input"
                                       placeholder="Nhập câu trả lời..."
                                       onchange="markQuestionAnswered(${displayIndex})"
                                       required>
                            </div>
                        `;
                        break;
                }

                questionCard.innerHTML = questionHtml;
                container.appendChild(questionCard);
            });

            // Initialize first question as active
            if (navGrid.firstChild) {
                navGrid.firstChild.classList.add('active');
            }

            // Initialize KaTeX rendering
            if (typeof renderMathInElement === 'function') {
                renderMathInElement(container, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false},
                        {left: "\\(", right: "\\)", display: false},
                        {left: "\\[", right: "\\]", display: true}
                    ],
                    throwOnError: false
                });
            }
        }

        // Option selection handlers
        function selectOption(questionIndex, value, element) {
            // Remove selected class from all options
            const allOptions = element.parentElement.querySelectorAll('.option-card');
            allOptions.forEach(opt => opt.classList.remove('selected'));
            
            // Add selected class to clicked option
            element.classList.add('selected');
            
            // Check the radio button
            const radio = element.querySelector('input[type="radio"]');
            radio.checked = true;
            
            // Mark question as answered
            const displayIndex = Array.from(document.querySelectorAll('.question-card'))
                .findIndex(card => card.dataset.questionIndex == questionIndex);
            markQuestionAnswered(displayIndex);
        }

        function selectTrueFalse(questionIndex, optionIndex, value, element) {
            // Remove selected class from both buttons
            const buttons = element.parentElement.querySelectorAll('.truefalse-btn');
            buttons.forEach(btn => {
                btn.classList.remove('selected-true', 'selected-false');
            });
            
            // Add appropriate class
            element.classList.add(value ? 'selected-true' : 'selected-false');
            
            // Check the radio button
            const radio = element.querySelector('input[type="radio"]');
            radio.checked = true;
            
            // Check if all options are answered for this question
            const questionCard = document.querySelector(`[data-question-index="${questionIndex}"]`);
            const allRadios = questionCard.querySelectorAll('input[type="radio"]');
            const checkedRadios = questionCard.querySelectorAll('input[type="radio"]:checked');
            
            if (allRadios.length / 2 === checkedRadios.length) {
                const displayIndex = Array.from(document.querySelectorAll('.question-card'))
                    .findIndex(card => card.dataset.questionIndex == questionIndex);
                markQuestionAnswered(displayIndex);
            }
        }

        // Submit confirmation
        function showConfirmationModal() {
            const modal = document.getElementById('confirmation-modal');
            const totalQuestions = document.querySelectorAll('.question-card').length;
            
            document.getElementById('modal-answered').textContent = answeredQuestions.size;
            document.getElementById('modal-unanswered').textContent = totalQuestions - answeredQuestions.size;
            document.getElementById('modal-flagged').textContent = flaggedQuestions.size;
            
            modal.classList.add('show');
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').classList.remove('show');
        }

        async function confirmSubmit() {
            const submitButton = document.getElementById('submit-quiz-btn');
            submitButton.disabled = true;
            submitButton.textContent = 'Đang nộp bài...';
            
            // Continue with existing submit logic...
            await submitQuiz();
        }

        // Modified submit function
        async function submitQuiz() {
            try {
                // Get IP address
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                
                const lessonId = currentLessonData.id;
                const lesson = currentLessonData;
                
                let score = 0;
                let totalPossiblePoints = 0;
                const timeTaken = (Date.now() - startTime) / 1000;

                const quizResults = {
                    lessonId: lessonId,
                    questions: [],
                    ipAddress: ipData.ip,
                    submittedAt: new Date().toISOString(),
                    timeTaken: timeTaken
                };

                // Process all questions...
                const questionElements = document.querySelectorAll('.question-card');
                questionElements.forEach((questionElement) => {
                    const originalIndex = parseInt(questionElement.dataset.questionIndex);
                    const q = lesson.questions[originalIndex];
                    
                    const questionPoints = (typeof q.points === 'number' && q.points > 0) ? q.points : 1;
                    totalPossiblePoints += questionPoints;

                    let userAnswer, correctAnswer, isCorrect, optionsText = null;
                    
                    // Extract image URL if present
                    let imageUrl = null;
                    const imgRegex = /\[img\s+src="([^"]+)"\]/i;
                    const originalQuestionText = lesson.questions[originalIndex].question;
                    const match = originalQuestionText.match(imgRegex);
                    if (match && match[1]) {
                        imageUrl = match[1];
                    }
                    
                    let questionTextForSaving = originalQuestionText;
                    if (imageUrl) {
                        questionTextForSaving = questionTextForSaving.replace(imgRegex, '').trim();
                    }

                    // Process answers based on question type
                    // Handle both old format (multiple_choice) and new format (abcd)
                    const normalizedType = q.type === 'multiple_choice' ? 'abcd' :
                                         q.type === 'true_false' ? 'truefalse' :
                                         q.type === 'fill_blank' ? 'number' : q.type;

                    // Get correct answer from either 'correct' or 'correctAnswer' property
                    const correctAnswerValue = q.correct !== undefined ? q.correct : q.correctAnswer;

                    if (normalizedType === 'truefalse' && Array.isArray(q.options)) {
                        const userAnswersArray = q.options.map((_, idx) => {
                            const selectedInput = document.querySelector(`input[name="q${originalIndex}_${idx}"]:checked`);
                            return selectedInput ? selectedInput.value === 'true' : null;
                        });

                        const correctAnswersArray = correctAnswerValue;
                        optionsText = q.options.map(opt => opt.text || opt);

                        isCorrect = Array.isArray(correctAnswersArray) &&
                                    correctAnswersArray.every((correctAns, idx) =>
                                        userAnswersArray[idx] !== null && userAnswersArray[idx] === correctAns
                                    );

                        userAnswer = userAnswersArray;
                        correctAnswer = correctAnswersArray;
                    } else if (normalizedType === 'abcd') {
                        const selectedRadio = document.querySelector(`input[name="q${originalIndex}"]:checked`);
                        const selectedValue = selectedRadio ? selectedRadio.value : null;

                        if (Array.isArray(q.options)) {
                            optionsText = q.options.map(opt => opt.text || opt);
                        } else {
                            optionsText = [];
                        }

                        if (selectedValue) {
                            const mapping = questionMappings[originalIndex];
                            const selectedMapping = mapping ? mapping.find(m => m.displayedLetter === selectedValue) : null;
                            
                            if (selectedMapping && q.options[selectedMapping.originalIndex]) {
                                const option = q.options[selectedMapping.originalIndex];
                                userAnswer = option.text || option;
                                
                                const correctIndex = correctAnswerValue.toUpperCase().charCodeAt(0) - 65;
                                if (correctIndex >= 0 && correctIndex < q.options.length) {
                                    const correctOption = q.options[correctIndex];
                                    correctAnswer = correctOption.text || correctOption;
                                    isCorrect = selectedMapping.originalIndex === correctIndex;
                                } else {
                                    correctAnswer = 'Error: Invalid correct answer specified';
                                    isCorrect = false;
                                }
                            }
                        } else {
                            userAnswer = 'No answer';
                            const correctIndex = correctAnswerValue.toUpperCase().charCodeAt(0) - 65;
                            if (correctIndex >= 0 && correctIndex < q.options.length) {
                                const correctOption = q.options[correctIndex];
                                correctAnswer = correctOption.text || correctOption;
                            } else {
                                correctAnswer = 'Error: Invalid correct answer specified';
                            }
                            isCorrect = false;
                        }
                    } else if (q.type === 'number') {
                        const inputElement = document.querySelector(`[name="q${originalIndex}"]`);
                        userAnswer = inputElement ? inputElement.value : 'No input found';
                        correctAnswer = q.correct.toString();
                        isCorrect = userAnswer !== '' && userAnswer === correctAnswer;
                    }

                    quizResults.questions.push({
                        type: q.type,
                        question: questionTextForSaving,
                        imageUrl: imageUrl,
                        userAnswer: userAnswer,
                        correctAnswer: correctAnswer,
                        isCorrect: isCorrect,
                        points: questionPoints,
                        earnedPoints: isCorrect ? questionPoints : 0,
                        optionsText: optionsText
                    });

                    if (isCorrect) {
                        score += questionPoints;
                    }
                });
                
                quizResults.totalPoints = totalPossiblePoints;
                quizResults.score = score;

                // Submit results
                let studentInfo = { name: 'Anonymous Student' };
                try {
                    const authResponse = await fetch('/api/auth/student/check');
                    if (authResponse.ok) {
                        const authData = await authResponse.json();
                        if (authData.isAuthenticated && authData.student) {
                            studentInfo = {
                                name: authData.student.name,
                                id: authData.student.id
                            };
                        }
                    }
                } catch (authError) {
                    console.warn('Could not get student info:', authError);
                }

                const answers = Array.isArray(quizResults.questions) ? quizResults.questions : [];
                const resultPayload = {
                    lessonId: quizResults.lessonId,
                    answers: answers,
                    timeTaken: Number(quizResults.timeTaken) || 0,
                    studentInfo: studentInfo
                };

                // Get CSRF token before making the request
                const csrfResponse = await fetch('/api/csrf-token');
                if (!csrfResponse.ok) {
                    throw new Error('Failed to get CSRF token');
                }
                const csrfData = await csrfResponse.json();

                // Add CSRF token to the payload
                resultPayload.csrfToken = csrfData.csrfToken;

                const saveResponse = await fetch('/api/results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(resultPayload)
                });

                if (!saveResponse.ok) {
                    const errorData = await saveResponse.json();
                    throw new Error(errorData.message || 'Failed to save results');
                }

                const resultData = await saveResponse.json();
                
                localStorage.setItem('quizResults', JSON.stringify({
                    lessonId: quizResults.lessonId,
                    score: quizResults.score,
                    totalPoints: quizResults.totalPoints,
                    resultId: resultData.resultId
                }));
                
                window.location.href = `/result/${resultData.resultId}`;

            } catch (error) {
                console.error('Error submitting quiz:', error);
                alert('Đã xảy ra lỗi khi nộp bài. Vui lòng thử lại.');
                
                const submitButton = document.getElementById('submit-quiz-btn');
                submitButton.disabled = false;
                submitButton.textContent = 'Nộp bài';
            }
        }

        // Initialize lesson
        async function initializeLesson() {
            const isAuthenticated = await checkStudentAuthentication();
            
            showLoader(true);
            let lessonId = window.location.pathname.split('/')[2];
            document.title = 'Loading lesson...';
            
            try {
                let response;
                
                // Check if we're loading the last incomplete lesson
                if (lessonId === 'last-incomplete') {
                    response = await fetch('/api/lessons/last-incomplete');
                    if (!response.ok) {
                        throw new Error(`Failed to fetch last incomplete lesson: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    if (!result.lesson) {
                        // No incomplete lessons, redirect to lessons page
                        alert('Chúc mừng! Bạn đã hoàn thành tất cả các bài học.');
                        window.location.href = '/lessons';
                        return;
                    }
                    
                    // Update the URL to show the actual lesson ID
                    lessonId = result.lesson.id;
                    window.history.replaceState({}, '', `/lesson/${lessonId}`);
                    
                    // Now fetch the full lesson data
                    response = await fetch(`/api/lessons/${lessonId}`);
                } else {
                    response = await fetch(`/api/lessons/${lessonId}`);
                }
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch lesson: ${response.status}`);
                }
                
                const responseData = await response.json();
                const lesson = responseData.lesson || responseData;
                currentLessonData = lesson;

                if (lesson.error || responseData.error) {
                    document.body.innerHTML = '<h1>Lesson not found</h1>';
                    currentLessonData = null;
                    return;
                }
                
                document.title = lesson.title;
                const titleElement = document.getElementById('lesson-title');
                if (titleElement) {
                    titleElement.textContent = lesson.title;
                }
                
                await renderQuestions(lesson);
                showLoader(false);
                
                // Start timer
                startTimer();
                
                // Update initial stats
                updateStats();

            } catch (error) {
                console.error('Error loading lesson:', error);
                document.body.innerHTML = `
                    <h1>Error loading lesson</h1>
                    <p>Error details: ${error.message}</p>
                `;
                showLoader(false);
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const submitButton = document.getElementById('submit-quiz-btn');
            if (submitButton) {
                submitButton.addEventListener('click', async () => {
                    const isAuthenticated = await checkStudentAuthentication();
                    if (!isAuthenticated) {
                        promptForLogin();
                        return;
                    }

                    if (!currentLessonData) {
                        alert("Lỗi: Dữ liệu bài học chưa được tải. Vui lòng tải lại trang.");
                        return;
                    }
                    
                    showConfirmationModal();
                });
            }

            initializeLesson();
        });

        // Mobile sidebar toggle functions
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('exam-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isVisible = sidebar.classList.contains('show');
            
            if (isVisible) {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
                document.body.style.overflow = '';
            } else {
                sidebar.classList.add('show');
                overlay.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        }

        // Image modal functions
        function openImageModal(imageSrc) {
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            modalImage.src = imageSrc;
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('image-modal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        // Event listeners for mobile functionality
        document.addEventListener('DOMContentLoaded', () => {
            // Mobile sidebar toggle
            const mobileToggle = document.getElementById('mobile-sidebar-toggle');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            if (mobileToggle) {
                mobileToggle.addEventListener('click', toggleMobileSidebar);
            }
            
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', toggleMobileSidebar);
            }

            // Image modal close on click
            const imageModal = document.getElementById('image-modal');
            if (imageModal) {
                imageModal.addEventListener('click', (e) => {
                    if (e.target === imageModal) {
                        closeImageModal();
                    }
                });
            }

            // Close modal on ESC key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeImageModal();
                }
            });
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' && currentQuestionIndex > 0) {
                navigateQuestion(-1);
            } else if (e.key === 'ArrowRight' && currentQuestionIndex < document.querySelectorAll('.question-card').length - 1) {
                navigateQuestion(1);
            }
        });
    </script>
</body>
</html>