<!DOCTYPE html>
<html>
<head>
    <title>M√†n h√¨nh gi√°o vi√™n - Ch·ªânh s·ª≠a n·ªôi dung b√†i h·ªçc</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="/css/style.css">
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/theme/default.css"> <!-- Using default theme -->
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
    <!-- Custom styles for KaTeX -->
    <style>
        /* Hide the katex-html elements while keeping katex-mathml visible */
        /* KaTeX accessibility: Keep HTML for visual rendering and MathML for screen readers */
        .katex .katex-mathml {
            /* Hide MathML from visual display but keep for screen readers */
            position: absolute;
            clip: rect(1px, 1px, 1px, 1px);
            padding: 0;
            border: 0;
            height: 1px;
            width: 1px;
            overflow: hidden;
        }
    </style>
    <!-- Keep theme CSS for now, JS change will apply default -->
</head>
<body>
    <a href="/" class="home-button">
        <img src="https://styles.redditmedia.com/t5_851o4i/styles/profileIcon_0elfudeu2s5b1.jpg?width=256&height=256&frame=1&auto=webp&crop=256:256,smart&s=86be605407a08efe2894a6bacd089074aca51879" alt="Home">
    </a>

    <!-- Document Upload Popup Overlay -->
    <div id="document-upload-popup" class="popup-overlay">
        <div class="popup-container">
            <div class="popup-header">
                <h2>üöÄ T·∫°o b√†i h·ªçc m·ªõi</h2>
                <button type="button" class="popup-close" onclick="closeUploadPopup()">&times;</button>
            </div>

            <div class="popup-content">
                <!-- Initial Choice Screen -->
                <div id="choice-screen" class="choice-screen">
                    <p class="choice-subtitle">Ch·ªçn c√°ch b·∫°n mu·ªën t·∫°o n·ªôi dung b√†i h·ªçc</p>

                    <div class="choice-options">
                        <div class="choice-option" onclick="chooseManualCreation()">
                            <div class="choice-icon">‚úèÔ∏è</div>
                            <h3>T·∫°o th·ªß c√¥ng</h3>
                            <p>Nh·∫≠p n·ªôi dung b√†i h·ªçc tr·ª±c ti·∫øp</p>
                        </div>

                        <div class="choice-option" onclick="chooseDocumentUpload()">
                            <div class="choice-icon">üìÑ</div>
                            <h3>T·∫£i l√™n t√†i li·ªáu</h3>
                            <p>AI t·ª± ƒë·ªông ƒë·ªãnh d·∫°ng t·ª´ PDF/DOCX</p>
                        </div>
                    </div>
                </div>

                <!-- Document Upload Screen -->
                <div id="upload-screen" class="upload-screen" style="display: none;">
                    <div class="upload-header">
                        <button type="button" class="back-btn" onclick="showChoiceScreen()">‚Üê Quay l·∫°i</button>
                        <h3>üìÑ T·∫£i l√™n t√†i li·ªáu</h3>
                    </div>

                    <div id="upload-dropzone" class="upload-dropzone">
                        <div class="dropzone-content">
                            <div class="upload-icon">üìÅ</div>
                            <p class="upload-text">K√©o th·∫£ file v√†o ƒë√¢y</p>
                            <div class="upload-divider">
                                <span>ho·∫∑c</span>
                            </div>
                            <button type="button" class="btn-browse" onclick="document.getElementById('file-input').click()">
                                üìÇ Ch·ªçn file t·ª´ m√°y t√≠nh
                            </button>
                            <input type="file" id="file-input" accept=".pdf,.docx" style="display: none;" onchange="handleFileSelect(event)">
                            <p class="upload-hint">H·ªó tr·ª£ PDF v√† DOCX ‚Ä¢ T·ªëi ƒëa 10MB</p>
                        </div>
                    </div>

                    <div id="file-preview" class="file-preview" style="display: none;">
                        <div class="file-card">
                            <div class="file-icon">üìÑ</div>
                            <div class="file-details">
                                <div class="file-name"></div>
                                <div class="file-size"></div>
                            </div>
                            <button type="button" class="remove-file-btn" onclick="removeFile()" title="X√≥a file">üóëÔ∏è</button>
                        </div>
                    </div>

                    <div id="upload-error" class="upload-error" style="display: none;"></div>

                    <div id="processing-status" class="processing-status" style="display: none;">
                        <div class="processing-header">
                            <div class="processing-spinner">‚ö°</div>
                            <h3>ƒêang x·ª≠ l√Ω t√†i li·ªáu...</h3>
                        </div>

                        <div class="processing-steps">
                            <div class="processing-step" data-step="upload">
                                <div class="step-icon">üì§</div>
                                <span>T·∫£i l√™n file</span>
                                <div class="step-status">‚è≥</div>
                            </div>
                            <div class="processing-step" data-step="extract">
                                <div class="step-icon">üîç</div>
                                <span>Tr√≠ch xu·∫•t n·ªôi dung</span>
                                <div class="step-status">‚è≥</div>
                            </div>
                            <div class="processing-step" data-step="ai">
                                <div class="step-icon">ü§ñ</div>
                                <span>AI ƒëang ƒë·ªãnh d·∫°ng</span>
                                <div class="step-status">‚è≥</div>
                            </div>
                            <div class="processing-step" data-step="complete">
                                <div class="step-icon">‚úÖ</div>
                                <span>Ho√†n t·∫•t</span>
                                <div class="step-status">‚è≥</div>
                            </div>
                        </div>

                        <div class="processing-message"></div>
                    </div>

                    <div class="upload-actions">
                        <button type="button" class="btn-secondary" onclick="closeUploadPopup()">H·ªßy</button>
                        <button type="button" id="process-btn" class="btn-primary" onclick="processDocument()" disabled>
                            ‚ö° X·ª≠ l√Ω t√†i li·ªáu
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div>
    </div>

    <div class="lesson-editor stage-1">
        <div class="editor-header">
            <h1><i class="fas fa-chalkboard-teacher"></i> Ch·ªânh s·ª≠a n·ªôi dung b√†i h·ªçc</h1>
            <div class="header-actions">
                <button onclick="proceedToConfiguration()" class="next-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 17l5-5-5-5M6 17l5-5-5-5"/></svg>
                    <span>Ti·∫øp t·ª•c: C·∫•u h√¨nh</span>
                </button>
                <a href="/admin" class="back-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    <span>Tr·ªü v·ªÅ danh s√°ch</span>
                </a>
            </div>
        </div>

        <!-- Editor and Preview Section -->
        <div class="editor-preview-container">
            <!-- Text Editor Panel - Left Side -->
            <div class="text-editor-main-panel">
                <div class="editor-toolbar">
                     <h2><i class="fas fa-edit"></i> C√¢u h·ªèi (Nh·∫≠p vƒÉn b·∫£n)</h2>
                     <div class="toolbar-buttons">
                         <button onclick="triggerImageUpload()" title="T·∫£i ·∫£nh l√™n"><i class="fas fa-upload"></i> T·∫£i ·∫£nh</button> 
                         <button onclick="addImageFromUrl()" title="Th√™m ·∫£nh t·ª´ URL"><i class="fas fa-link"></i> ·∫¢nh URL</button>
                         <button onclick="insertLatexDelimiters('$$')" title="Th√™m LaTeX ($$...$$)"><i class="fas fa-calculator"></i> LaTeX</button>
                         <button onclick="insertLatexDelimiters('$')" title="Th√™m LaTeX ($...$)"><i class="fas fa-square-root-alt"></i> LaTeX</button>
                         <!-- Add other toolbar buttons if needed -->
                     </div>
                 </div>
                <textarea id="text-editor" spellcheck="false" placeholder="Nh·∫≠p n·ªôi dung b√†i h·ªçc t·∫°i ƒë√¢y...&#10;&#10;V√≠ d·ª•:&#10;C√¢u 1: Trong cu·ªôc khai th√°c thu·ªôc ƒë·ªãa l·∫ßn th·ª© hai ·ªü ƒê√¥ng D∆∞∆°ng 1919-1929, th·ª±c d√¢n Ph√°p t·∫≠p trung ƒë·∫ßu t∆∞ v√†o&#10;A. Ng√†nh ch·∫ø t·∫°o m√°y.&#10;B. C√¥ng nghi·ªáp luy·ªán kim.&#10;C. ƒê·ªìn ƒëi·ªÅn cao su.&#10;D. C√¥ng nghi·ªáp h√≥a ch·∫•t."></textarea>
                <!-- Add hidden file input for image uploads -->
                <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
            </div>
            
            <!-- Preview Panel - Right Side -->
            <div class="preview-panel">
                 <h2><i class="fas fa-eye"></i> Xem tr∆∞·ªõc</h2>
                 <div id="realtime-preview" class="azota-preview">
                     <p class="preview-placeholder">
                         <i class="fas fa-file-alt"></i><br>
                         Xem tr∆∞·ªõc s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y...<br>
                         <small>Nh·∫≠p n·ªôi dung b√™n tr√°i ƒë·ªÉ xem k·∫øt qu·∫£ hi·ªÉn th·ªã</small>
                     </p>
                 </div>
            </div>
        </div>
        
        <!-- Remove the old JSON editor panel -->
        <!-- Remove the old questions container and add button -->

    </div>
    
    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/javascript/javascript.min.js"></script> 
    <!-- KaTeX JS -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
    <!-- Optional: KaTeX auto-render extension -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
    
    <!-- CSRF utilities for secure API requests -->
    <script src="/js/csrf-utils.js?v=2"></script>
    <script src="/js/admin-stage1-editor.js?v=2"></script>
    <!-- Document upload functionality -->
    <script src="/js/document-upload.js?v=2"></script>
    <!-- Storage recovery script to help with session storage issues -->
    <script src="/js/storage-recovery.js?v=2"></script>
    <!-- Keep drag utils if needed for other parts, otherwise remove -->
    <!-- <script src="/js/drag-utils.js"></script> --> 
     <!-- Font Awesome for icons -->
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</body>
</html>